

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>justHealthServer.views &mdash; JustHealth 1 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="JustHealth 1 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../index.html" class="fa fa-home"> JustHealth</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../examiner.html">Examiners Guide to JustHealth</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../examiner.html#website">Website</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examiner.html#android">Android</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examiner.html#testing-portal">Testing Portal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examiner.html#documentation">Documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../arch.html">Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../arch.html#overall-structure">Overall Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../arch.html#the-api-server">The API server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../arch.html#the-orm">The ORM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../arch.html#the-database">The Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../arch.html#the-web-application">The Web application</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../arch.html#the-android-application">The Android application</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../arch.html#documentation">Documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../development.html">Development</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../development.html#general-development-process">General Development Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../development.html#development-tools">Development Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../development.html#testing">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../development.html#automated-api-tests">Automated API Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../development.html#runtests-sh">runTests.sh</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Full API Listing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-justHealthServer.api">Accounts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../views.html">Full Views Listing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#user-login">User Login</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#register">Register</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#search">Search</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#deactivate">Deactivate</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#user-logout">User Logout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#user-verification">User Verification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#forgot-password">Forgot Password</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#password-reset">Password Reset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#appointments">Appointments</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#my-patients">My Patients</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#prescriptions">Prescriptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#connections">Connections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#notes">Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#contact-us">Contact Us</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#error-handling">Error Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#justhealth-admin-portal">JustHealth Admin Portal</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../users.html">User Functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../database.html">Database</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../database.html#module-justHealthServer.database">Client</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../html.html">HTML Listing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#frontpage-html">frontpage.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#login-html">login.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#register-html">register.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#dashboard-html">dashboard.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#dashboardcarer-html">dashboardCarer.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#editprofile-html">editProfile.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#deactivate-html">deactivate.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#search-html">search.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#changepassword-html">changePassword.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#resetpassword-html">resetpassword.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#resetpasswordnowquestion-html">resetpasswordnowquestion.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#expiredpassword-html">expiredpassword.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#mypatients-html">myPatients.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#carerappointments-html">carerAppointments.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#patientappointments-html">patientAppointments.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#patientupdateappointment-html">patientUpdateAppointment.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#prescriptions-html">prescriptions.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#correspondence-html">correspondence.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#patientnotes-html">patientNotes.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#contactus-html">contactUs.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#faq-html">faq.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#template-html">template.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#searchnhsdirect-html">searchNHSDirect.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#settings-html">settings.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#error-pages">error pages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#admin-pages">Admin Pages</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../security.html">Security Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../security.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security.html#https">HTTPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security.html#password-security">Password Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security.html#api-authentication">API Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security.html#sql-injection">SQL Injection</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">JustHealth</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>justHealthServer.views</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <h1>Source code for justHealthServer.views</h1><div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">send_from_directory</span>
<span class="kn">from</span> <span class="nn">justHealthServer</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">webbrowser</span>

<span class="c"># Decorator Functions</span>
<span class="k">def</span> <span class="nf">needLogin</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
  <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">loginCheck</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="c"># session[&#39;username&#39;] doesn&#39;t exist, kick to login screen</span>
      <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;login&#39;</span><span class="p">))</span>
    <span class="c"># User logged in, continue as normal</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">loginCheck</span>

<span class="k">def</span> <span class="nf">needAdmin</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">needAdmin</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;Admin&quot;</span><span class="p">:</span>
            <span class="c"># If the URL for admin portal is attempted, check for authorisation.</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;401Unauthorised.html&#39;</span><span class="p">),</span> <span class="mi">401</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">needAdmin</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/images/&lt;filename&gt;&#39;</span><span class="p">)</span>
<span class="nd">@needLogin</span>
<div class="viewcode-block" id="getProfilePicture"><a class="viewcode-back" href="../../views.html#justHealthServer.views.getProfilePicture">[docs]</a><span class="k">def</span> <span class="nf">getProfilePicture</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the user&#39;s profile picture from the JustHealth images folder on the server&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;PROFILE_PICTURE&#39;</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">frontPage</span><span class="p">():</span>
    <span class="c"># Checks if a user session is set, if not kick to the front page, instead of dashboard</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;frontPage.html&#39;</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/home&#39;</span><span class="p">)</span>
<span class="nd">@needLogin</span>
<div class="viewcode-block" id="index"><a class="viewcode-back" href="../../views.html#justHealthServer.views.index">[docs]</a><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Sends user to a dashboard according to account type if session is active, it shows their profile and connections. A patient will be able to see their notifications, prescriptions and appointments. A carer will be able to see their notifications, the patients that they are connected to (with prescriptions and appointments) and their own appointments&quot;&quot;&quot;</span>
    <span class="c">## set common functionality for all account types</span>
    <span class="n">accountInfo</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">accountInfo</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Admin&quot;</span><span class="p">:</span>
        <span class="c"># direct user to the admin portal</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;adminPortal&#39;</span><span class="p">))</span>

    <span class="c"># common functionality for patient and carer</span>
    <span class="n">connections</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getConnections</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
    <span class="n">appointments</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAllAppointments</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
    <span class="n">outgoingConnections</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">connections</span><span class="p">[</span><span class="s">&#39;outgoing&#39;</span><span class="p">])</span>
    <span class="n">incomingConnections</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">connections</span><span class="p">[</span><span class="s">&#39;incoming&#39;</span><span class="p">])</span>
    <span class="n">completedConnections</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">connections</span><span class="p">[</span><span class="s">&#39;completed&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">accountInfo</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Patient&quot;</span><span class="p">:</span>
        <span class="c"># Patient Functionality</span>
        <span class="n">notifications</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getNotifications</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
        <span class="n">prescriptions</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getPrescriptions</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
        <span class="n">reminders</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getReminders</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s">&#39;dashboard.html&#39;</span><span class="p">,</span>
            <span class="n">accountInfo</span><span class="o">=</span><span class="n">accountInfo</span><span class="p">,</span>
            <span class="n">notifications</span><span class="o">=</span><span class="n">notifications</span><span class="p">,</span>
            <span class="n">connections</span><span class="o">=</span><span class="n">connections</span><span class="p">,</span>
            <span class="n">appType</span><span class="o">=</span><span class="n">Appointmenttype</span><span class="o">.</span><span class="n">select</span><span class="p">(),</span>
            <span class="n">appointments</span><span class="o">=</span><span class="n">appointments</span><span class="p">,</span>
            <span class="n">prescriptions</span> <span class="o">=</span> <span class="n">prescriptions</span><span class="p">,</span>
            <span class="n">outgoing</span><span class="o">=</span><span class="n">outgoingConnections</span><span class="p">,</span>
            <span class="n">incoming</span><span class="o">=</span><span class="n">incomingConnections</span><span class="p">,</span>
            <span class="n">completed</span><span class="o">=</span><span class="n">completedConnections</span><span class="p">,</span>
            <span class="n">reminders</span> <span class="o">=</span> <span class="n">reminders</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">accountInfo</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Carer&quot;</span><span class="p">:</span>
        <span class="c"># Carer Functionality</span>
        
        <span class="c"># Get Carer&#39;s Patients</span>
        <span class="k">if</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Carer&#39;</span><span class="p">:</span>
            <span class="c"># Get all patients connected to this user</span>
            <span class="n">connections</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getConnections</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
            <span class="n">completedConnections</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">connections</span><span class="p">[</span><span class="s">&#39;completed&#39;</span><span class="p">])</span>

            <span class="n">patients</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">completedConnections</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">connection</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Patient&quot;</span><span class="p">:</span>
                    <span class="n">patients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        
        <span class="n">appointmentsMapping</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">activePrescriptions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">upcomingPrescriptions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">expiredPrescriptions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">patient</span> <span class="ow">in</span> <span class="n">patients</span><span class="p">:</span>
            <span class="n">appointmentsMapping</span><span class="p">[</span><span class="n">patient</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAllAppointments</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="n">patient</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
            <span class="n">activePrescriptions</span><span class="p">[</span><span class="n">patient</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getActivePrescriptions</span><span class="p">(</span><span class="n">patient</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
            <span class="n">upcomingPrescriptions</span><span class="p">[</span><span class="n">patient</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getUpcomingPrescriptions</span><span class="p">(</span><span class="n">patient</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
            <span class="n">expiredPrescriptions</span><span class="p">[</span><span class="n">patient</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getExpiredPrescriptions</span><span class="p">(</span><span class="n">patient</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
            <span class="c"># checkPrescriptionLevel(session[&#39;username&#39;], activePrescriptions[patient[&#39;username&#39;]])</span>

        <span class="c"># Notifications relies on some of the methods above and therefore needs to be run at the end of this block.</span>
        <span class="c"># Otherwise the notification won&#39;t be displayed until the refresh after it is created.</span>
        <span class="n">notifications</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getNotifications</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
        <span class="n">reminders</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getReminders</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s">&#39;dashboardCarer.html&#39;</span><span class="p">,</span>
            <span class="n">accountInfo</span><span class="o">=</span><span class="n">accountInfo</span><span class="p">,</span>
            <span class="n">notifications</span><span class="o">=</span><span class="n">notifications</span><span class="p">,</span>
            <span class="n">reminders</span><span class="o">=</span><span class="n">reminders</span><span class="p">,</span>
            <span class="n">connections</span><span class="o">=</span><span class="n">connections</span><span class="p">,</span>
            <span class="n">appointments</span><span class="o">=</span><span class="n">appointments</span><span class="p">,</span>
            <span class="n">outgoing</span><span class="o">=</span><span class="n">outgoingConnections</span><span class="p">,</span>
            <span class="n">incoming</span><span class="o">=</span><span class="n">incomingConnections</span><span class="p">,</span>
            <span class="n">completed</span><span class="o">=</span><span class="n">completedConnections</span><span class="p">,</span>
            <span class="n">patients</span> <span class="o">=</span> <span class="n">patients</span><span class="p">,</span>
            <span class="n">appointmentsMapping</span> <span class="o">=</span> <span class="n">appointmentsMapping</span><span class="p">,</span>
            <span class="n">activePrescriptions</span> <span class="o">=</span> <span class="n">activePrescriptions</span><span class="p">,</span>
            <span class="n">upcomingPrescriptions</span> <span class="o">=</span> <span class="n">upcomingPrescriptions</span><span class="p">,</span>
            <span class="n">expiredPrescriptions</span> <span class="o">=</span> <span class="n">expiredPrescriptions</span><span class="p">,</span>
            <span class="n">appType</span><span class="o">=</span><span class="n">Appointmenttype</span><span class="o">.</span><span class="n">select</span><span class="p">(),</span>
            <span class="n">medicationList</span> <span class="o">=</span> <span class="n">Medication</span><span class="o">.</span><span class="n">select</span><span class="p">())</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/profile&#39;</span><span class="p">)</span>
<span class="nd">@needLogin</span>
<span class="k">def</span> <span class="nf">profile</span><span class="p">():</span>
    <span class="c"># Redundant function as the profile page is no longer in use </span>
    <span class="sd">&quot;&quot;&quot;Profile page to display all current users details&quot;&quot;&quot;</span>
    <span class="n">profileDetails</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>

    <span class="n">connections</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getConnections</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
    <span class="n">outgoingConnections</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">connections</span><span class="p">[</span><span class="s">&#39;outgoing&#39;</span><span class="p">])</span>
    <span class="n">incomingConnections</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">connections</span><span class="p">[</span><span class="s">&#39;incoming&#39;</span><span class="p">])</span>
    <span class="n">completedConnections</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">connections</span><span class="p">[</span><span class="s">&#39;completed&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">profileDetails</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Patient&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;profile.html&#39;</span><span class="p">,</span> <span class="n">profileDetails</span><span class="o">=</span><span class="n">profileDetails</span><span class="p">,</span> <span class="n">outgoing</span><span class="o">=</span><span class="n">outgoingConnections</span><span class="p">,</span> <span class="n">incoming</span><span class="o">=</span><span class="n">incomingConnections</span><span class="p">,</span> <span class="n">completed</span><span class="o">=</span><span class="n">completedConnections</span><span class="p">,</span> <span class="n">printaccounttype</span> <span class="o">=</span> <span class="s">&#39;Patient&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">profileDetails</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Carer&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;profile.html&#39;</span><span class="p">,</span> <span class="n">profileDetails</span><span class="o">=</span><span class="n">profileDetails</span><span class="p">,</span> <span class="n">outgoing</span><span class="o">=</span><span class="n">outgoingConnections</span><span class="p">,</span> <span class="n">incoming</span><span class="o">=</span><span class="n">incomingConnections</span><span class="p">,</span> <span class="n">completed</span><span class="o">=</span><span class="n">completedConnections</span><span class="p">,</span> <span class="n">printaccounttype</span> <span class="o">=</span> <span class="s">&#39;Carer&#39;</span> <span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/editProfile&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<span class="k">def</span> <span class="nf">getEditDetails_view</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;GET&#39;</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">)</span>
        <span class="n">getUpdate</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;editProfile.html&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">getUpdate</span><span class="p">)</span>
   
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/updateProfile&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<span class="k">def</span> <span class="nf">editDetails_view</span><span class="p">():</span>
    <span class="n">updated</span> <span class="o">=</span> <span class="n">editProfile</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">updated</span> <span class="o">==</span> <span class="s">&quot;Failed&quot;</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">updated</span><span class="p">,</span> <span class="s">&#39;danger&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># sets the profile picture in the session variable so that it updates on submit</span>
        <span class="n">nameresult</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
        <span class="n">session</span><span class="p">[</span><span class="s">&#39;profilepicture&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nameresult</span><span class="p">[</span><span class="s">&#39;profilepicture&#39;</span><span class="p">]</span>

        <span class="n">flash</span><span class="p">(</span><span class="n">updated</span><span class="p">,</span> <span class="s">&#39;success&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/termsandconditions&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">terms</span><span class="p">():</span>
    <span class="c"># Redundant page: content is now in a modal</span>
    <span class="sd">&quot;&quot;&quot;JustHealth terms and conditions reference page for all users&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;termsandconditions.html&#39;</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/corpusindex&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">corpus</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;indexCorpus.html&#39;</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/legal&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">legal</span><span class="p">():</span>
    <span class="c"># Redundant page: content is now in a modal</span>
    <span class="sd">&quot;&quot;&quot;This page hold 4 tiles each a link onto the respective legal page&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;legal.html&#39;</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/privacypolicy&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">privacy</span><span class="p">():</span>
    <span class="c"># Redundant page: content is now in a modal</span>
    <span class="sd">&quot;&quot;&quot;JustHealth privacy policy and data protection reference page&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;privacypolicy.html&#39;</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/references&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">references</span><span class="p">():</span>
    <span class="c"># Redundant page: content is now in a modal</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;references.html&#39;</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/faq&#39;</span><span class="p">)</span>
<span class="nd">@needLogin</span>
<span class="k">def</span> <span class="nf">faq</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;faq.html&#39;</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/sitemap&#39;</span><span class="p">)</span>
<span class="nd">@needLogin</span>
<span class="k">def</span> <span class="nf">sitemap</span><span class="p">():</span>
    <span class="c"># Redundant page: content is now in a modal</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;sitemap.html&#39;</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/contactUs&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<div class="viewcode-block" id="contactUs"><a class="viewcode-back" href="../../views.html#justHealthServer.views.contactUs">[docs]</a><span class="k">def</span> <span class="nf">contactUs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Shows a form to allow the user to contact JustHealth, it sends an email from the address associated with their account&quot;&quot;&quot;</span>
    <span class="n">profileDetails</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span> 
        <span class="n">result</span> <span class="o">=</span> <span class="n">sendContactUs</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;contactUs.html&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;success&quot;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;Your message has been sent, please allow up to 24 hours for a response&#39;</span><span class="p">,</span> <span class="n">profileDetails</span><span class="o">=</span><span class="n">profileDetails</span><span class="p">,</span> <span class="n">printaccounttype</span> <span class="o">=</span> <span class="n">profileDetails</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span> 
       <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;contactUs.html&#39;</span><span class="p">,</span> <span class="n">profileDetails</span><span class="o">=</span><span class="n">profileDetails</span><span class="p">,</span> <span class="n">printaccounttype</span> <span class="o">=</span> <span class="n">profileDetails</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">])</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/settings&#39;</span><span class="p">)</span>
<span class="nd">@needLogin</span>
<span class="k">def</span> <span class="nf">settings</span><span class="p">():</span>
    <span class="n">profileDetails</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">profileDetails</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Patient&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;settings.html&#39;</span><span class="p">,</span> <span class="n">profileDetails</span><span class="o">=</span><span class="n">profileDetails</span><span class="p">,</span> <span class="n">printaccounttype</span> <span class="o">=</span> <span class="s">&#39;Patient&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">profileDetails</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Carer&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;settings.html&#39;</span><span class="p">,</span> <span class="n">profileDetails</span><span class="o">=</span><span class="n">profileDetails</span><span class="p">,</span> <span class="n">printaccounttype</span> <span class="o">=</span> <span class="s">&#39;Carer&#39;</span> <span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/search&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<div class="viewcode-block" id="search"><a class="viewcode-back" href="../../views.html#justHealthServer.views.search">[docs]</a><span class="k">def</span> <span class="nf">search</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Search to find a different user, potentially so a connection can then be requested&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span><span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">searchPatientCarer</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;searchterm&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s">&quot;No users found&quot;</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&#39;danger&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span> <span class="p">(</span><span class="s">&#39;search.html&#39;</span><span class="p">,</span><span class="n">results</span> <span class="o">=</span> <span class="n">result</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;search.html&#39;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/deactivate&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<div class="viewcode-block" id="deactivate"><a class="viewcode-back" href="../../views.html#justHealthServer.views.deactivate">[docs]</a><span class="k">def</span> <span class="nf">deactivate</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Handles account deactivation form&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">deactivateAccount</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s">&quot;Deleted&quot;</span><span class="p">:</span>
            <span class="c"># if the checkbox is ticked, we delete their data and their account is completely deleted</span>
            <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;login.html&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;success&quot;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Your account has been deleted&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">result</span> <span class="o">==</span> <span class="s">&quot;Kept&quot;</span><span class="p">:</span>
            <span class="c"># if the checkbox is left unchecked, we keep their data but mark their account as deactivated</span>
            <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;login.html&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;success&quot;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Your account has been deactivated&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># deactive attempt failed</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;deactivate.html&#39;</span><span class="p">,</span> <span class="n">reasons</span> <span class="o">=</span> <span class="n">Deactivatereason</span><span class="o">.</span><span class="n">select</span><span class="p">(),</span> <span class="n">user</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;danger&quot;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;deactivate.html&#39;</span><span class="p">,</span> <span class="n">reasons</span> <span class="o">=</span> <span class="n">Deactivatereason</span><span class="o">.</span><span class="n">select</span><span class="p">(),</span> <span class="n">user</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>

<span class="c"># Account Pages</span></div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/register&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<div class="viewcode-block" id="registration"><a class="viewcode-back" href="../../views.html#justHealthServer.views.registration">[docs]</a><span class="k">def</span> <span class="nf">registration</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Handles user registration form&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">registerUser</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Thanks for registering! Please check your email for a verification link&quot;</span><span class="p">,</span> <span class="s">&quot;success&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">&#39;/login&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&quot;danger&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;register.html&#39;</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/logout&#39;</span><span class="p">)</span>
<span class="nd">@needLogin</span>
<div class="viewcode-block" id="logout"><a class="viewcode-back" href="../../views.html#justHealthServer.views.logout">[docs]</a><span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Terminates user session and redirects to the front page&quot;&quot;&quot;</span>
    <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/users/activate/&lt;payload&gt;&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="verifyUser"><a class="viewcode-back" href="../../views.html#justHealthServer.views.verifyUser">[docs]</a><span class="k">def</span> <span class="nf">verifyUser</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;User confirmation of account verification&quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">getSerializer</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">retrievedUsername</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">BadSignature</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

    <span class="n">verifiedTrue</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">verified</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">retrievedUsername</span><span class="p">)</span>
    <span class="n">verifiedTrue</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;login.html&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;success&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&#39;Thank you for verifying your account.&#39;</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/password&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<span class="k">def</span> <span class="nf">changePassword</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Opens a change password form (for when user knows their current password)&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">changePasswordAPI</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s">&quot;Password changed successfully&quot;</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&quot;success&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&quot;danger&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;changePassword&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;changePassword.html&#39;</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/users/activate/&lt;payload&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">passwordReset</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
    <span class="c"># forced password reset, if password is expiring etc.</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">getSerializer</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">retrievedUsername</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">BadSignature</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

    <span class="n">verifiedTrue</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">verified</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">retrievedUsername</span><span class="p">)</span>
    <span class="n">verifiedTrue</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;login.html&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;success&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&#39;Thank you, your password has now been reset and verified.&#39;</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/resetpassword/&lt;payload&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">loadPasswordReset</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
  <span class="n">s</span> <span class="o">=</span> <span class="n">getSerializer</span><span class="p">()</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
  <span class="k">except</span> <span class="n">BadSignature</span><span class="p">:</span>
    <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;resetpassword.html&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<div class="viewcode-block" id="login"><a class="viewcode-back" href="../../views.html#justHealthServer.views.login">[docs]</a><span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Gets the username from login in order to authenticate session, log the user in and redirects to index function&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s">&quot;Authenticated&quot;</span><span class="p">:</span>
            <span class="c"># Valid user, set SESSION</span>
            <span class="n">session</span><span class="p">[</span><span class="s">&quot;username&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
            <span class="n">nameresult</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
            <span class="n">session</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nameresult</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">]</span>
            <span class="n">session</span><span class="p">[</span><span class="s">&#39;surname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nameresult</span><span class="p">[</span><span class="s">&#39;surname&#39;</span><span class="p">]</span>
            <span class="n">session</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nameresult</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span>
            <span class="n">session</span><span class="p">[</span><span class="s">&#39;profilepicture&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nameresult</span><span class="p">[</span><span class="s">&#39;profilepicture&#39;</span><span class="p">]</span>
            <span class="n">fullname</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;surname&#39;</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>
        <span class="c"># Expired password here</span>
        <span class="k">elif</span> <span class="n">result</span> <span class="o">==</span> <span class="s">&quot;Reset&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;expiredpassword.html&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;Your password has expired and needs to be reset before you will be able to log in.&quot;</span><span class="p">,</span> <span class="n">submessage</span><span class="o">=</span><span class="s">&quot;JustHealth enforce this from time-to-time to ensure that your privacy and security are maximised whilst using the website.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">result</span> <span class="o">==</span> <span class="s">&quot;&lt;11&quot;</span><span class="p">:</span>
            <span class="n">session</span><span class="p">[</span><span class="s">&quot;username&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
            <span class="n">nameresult</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
            <span class="n">session</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nameresult</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">]</span>
            <span class="n">session</span><span class="p">[</span><span class="s">&#39;surname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nameresult</span><span class="p">[</span><span class="s">&#39;surname&#39;</span><span class="p">]</span>
            <span class="n">fullname</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;surname&#39;</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;resetpasswordnowquestion.html&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;login.html&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;danger&quot;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">result</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;login.html&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/expiredpassword&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">expiredpassword</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;This forces the user to the expired password page, and checks the password reset&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">reset</span> <span class="o">=</span> <span class="n">expiredResetPassword</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reset</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">:</span>
            <span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>
        <span class="c"># does not work, see API comments for details</span>
        <span class="c"># elif reset == &quot;Exists&quot;:</span>
        <span class="c">#      return render_template(&#39;expiredpassword.html&#39;, user=session[&#39;username&#39;], error=&quot;The password that you have tried to use has already been used as one of your last five passwords. Please try again.&quot;, errortype=&quot;danger&quot;)</span>
        
        <span class="k">elif</span> <span class="n">reset</span> <span class="o">==</span> <span class="s">&quot;Unmatched&quot;</span><span class="p">:</span>
            <span class="c"># handles the attempted password reset</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;expiredpassword.html&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="n">error</span><span class="o">=</span><span class="s">&quot;The two passwords you entered did not match, please try again.&quot;</span><span class="p">,</span> <span class="n">errortype</span><span class="o">=</span><span class="s">&quot;danger&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;expiredpassword.html&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="n">error</span><span class="o">=</span><span class="s">&quot;Oops, something went wrong. Please try again.&quot;</span><span class="p">,</span> <span class="n">errortype</span><span class="o">=</span><span class="s">&quot;danger&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;expiredpassword.html&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>
    

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/forgotPassword&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<div class="viewcode-block" id="forgotPassword"><a class="viewcode-back" href="../../views.html#justHealthServer.views.forgotPassword">[docs]</a><span class="k">def</span> <span class="nf">forgotPassword</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Finds the user&#39;s account from the email address it was registered with&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
      <span class="n">username</span> <span class="o">=</span> <span class="n">getUserFromEmail</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">username</span> <span class="o">==</span> <span class="s">&quot;False&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;login.html&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;danger&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;An account with this email address does not exist.&quot;</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">sendForgotPasswordEmail</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;login.html&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;success&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;An email has been sent to you containing a link, which will allow you to reset your password.&quot;</span><span class="p">)</span>

<span class="c"># This method is run once the form to reset the password has been submitted</span></div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/resetpassword&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<div class="viewcode-block" id="resetPasswordRedirect"><a class="viewcode-back" href="../../views.html#justHealthServer.views.resetPasswordRedirect">[docs]</a><span class="k">def</span> <span class="nf">resetPasswordRedirect</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Follows unique link in email to allow user to reset password, only after forgotPassword form is submitted.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">resetPassword</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;login.html&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;success&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;Your password has been reset, please check your email and click the link to verify.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;resetpassword.html&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;danger&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;The details that you entered are incorrect. Please try again.&quot;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;resetpassword.html&#39;</span><span class="p">)</span>

</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/createConnectionWeb&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<div class="viewcode-block" id="createConnectionWeb"><a class="viewcode-back" href="../../views.html#justHealthServer.views.createConnectionWeb">[docs]</a><span class="k">def</span> <span class="nf">createConnectionWeb</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Shows user a notification if a connection is attempted to tell them of the current connection state with that user&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">createConnection</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="s">&quot;Connection already established&quot;</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&#39;success&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&#39;danger&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">&#39;/home?go=connections&#39;</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/completeConnectionWeb&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<div class="viewcode-block" id="completeConnectionWeb"><a class="viewcode-back" href="../../views.html#justHealthServer.views.completeConnectionWeb">[docs]</a><span class="k">def</span> <span class="nf">completeConnectionWeb</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Shows user a notification of whether their attempt to verify a connection was successful, the user has to put in the correct 4 digit code to complete the connection&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">completeConnection</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s">&quot;Incorrect code&quot;</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&#39;danger&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&#39;success&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">&#39;/home?go=connections&#39;</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/deleteConnectionWeb&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<div class="viewcode-block" id="deleteConnectionWeb"><a class="viewcode-back" href="../../views.html#justHealthServer.views.deleteConnectionWeb">[docs]</a><span class="k">def</span> <span class="nf">deleteConnectionWeb</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Shows user a notification if their attempt to delete a connection was successful or not&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">deleteConnection</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Delete successful&quot;</span><span class="p">,</span> <span class="s">&#39;success&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Delete failed. Please try again or contact an administrator&quot;</span><span class="p">,</span> <span class="s">&#39;danger&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">&#39;/home?go=connections&#39;</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/cancelConnectionWeb&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<div class="viewcode-block" id="cancelConnectionWeb"><a class="viewcode-back" href="../../views.html#justHealthServer.views.cancelConnectionWeb">[docs]</a><span class="k">def</span> <span class="nf">cancelConnectionWeb</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Shows user a notification if their attempt to cancel their request for a connection was successful or not&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">cancelRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Cancellation successful&quot;</span><span class="p">,</span> <span class="s">&#39;success&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Cancellation failed. Please try again or contact an administrator&quot;</span><span class="p">,</span> <span class="s">&#39;danger&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">&#39;/home?go=connections&#39;</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/appointments&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<div class="viewcode-block" id="appointments"><a class="viewcode-back" href="../../views.html#justHealthServer.views.appointments">[docs]</a><span class="k">def</span> <span class="nf">appointments</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Form for patient to add an appointment, they choose privacy level for their carer.&quot;&quot;&quot;</span>
    <span class="n">appointments</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAllAppointments</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
  
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="c">#The tick box is not sent if it isn&#39;t ticked, so we have to catch it here.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">private</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;private&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
          <span class="n">private</span> <span class="o">=</span> <span class="s">&quot;False&quot;</span>
  
        <span class="n">details</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;creator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;apptype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;apptype&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;addressnamenumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;addressnamenumber&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;postcode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;postcode&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;endtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;endtime&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;private&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">private</span> 
  
        <span class="n">added</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">addPatientAppointment</span><span class="p">(</span><span class="n">details</span><span class="p">))</span>
  
        <span class="c">#checks that an id is returned</span>
        <span class="k">if</span> <span class="n">added</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> 
            <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Appointment Added&quot;</span><span class="p">,</span> <span class="s">&#39;success&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;appointments&#39;</span><span class="p">))</span>        
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;patientAppointments.html&#39;</span><span class="p">,</span> <span class="n">appType</span><span class="o">=</span><span class="n">Appointmenttype</span><span class="o">.</span><span class="n">select</span><span class="p">(),</span> <span class="n">appointments</span><span class="o">=</span><span class="n">appointments</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/deleteAppointment&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<div class="viewcode-block" id="deleteAppointment_view"><a class="viewcode-back" href="../../views.html#justHealthServer.views.deleteAppointment_view">[docs]</a><span class="k">def</span> <span class="nf">deleteAppointment_view</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Shows message to inform the user that the appointment has been deleted&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;GET&#39;</span><span class="p">:</span>
        <span class="n">appid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;appid&quot;</span><span class="p">)</span>
        <span class="n">deleted</span> <span class="o">=</span> <span class="n">deleteAppointment</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="n">appid</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">deleted</span><span class="p">,</span> <span class="s">&#39;success&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;appointments&#39;</span><span class="p">))</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/updateAppointment&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<div class="viewcode-block" id="getUpdateAppointment_view"><a class="viewcode-back" href="../../views.html#justHealthServer.views.getUpdateAppointment_view">[docs]</a><span class="k">def</span> <span class="nf">getUpdateAppointment_view</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Takes the appointment ID to put the existing appointment information in the form, ready to be updated&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;GET&#39;</span><span class="p">:</span>
        <span class="n">appid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;appid&#39;</span><span class="p">)</span>
        <span class="n">whereFrom</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;whereFrom&#39;</span><span class="p">)</span>
        <span class="n">getUpdate</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getUpdateAppointment</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="n">appid</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;patientUpdateAppointment.html&#39;</span><span class="p">,</span> <span class="n">appType</span><span class="o">=</span><span class="n">Appointmenttype</span><span class="o">.</span><span class="n">select</span><span class="p">(),</span> <span class="n">request</span><span class="o">=</span><span class="n">getUpdate</span><span class="p">,</span> <span class="n">previousLocation</span><span class="o">=</span><span class="n">whereFrom</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/patientUpdateAppointment&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<span class="k">def</span> <span class="nf">updateAppointment_view</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;If the privacy option isn&#39;t selected, the field isn&#39;t sent with the form, so it is caught and handled in this function&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="c">#The tick box is not sent if it isn&#39;t ticked, so we have to catch it here.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">private</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;private&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">private</span> <span class="o">=</span> <span class="s">&quot;False&quot;</span>

    <span class="n">updated</span> <span class="o">=</span> <span class="n">updateAppointment</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;appid&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;nameNumber&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;postcode&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;dateFrom&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;startTime&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;dateTo&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;endTime&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;other&#39;</span><span class="p">],</span> <span class="n">private</span><span class="p">)</span>
    <span class="n">flash</span><span class="p">(</span><span class="n">updated</span><span class="p">,</span> <span class="s">&#39;success&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;whereFrom&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;myPatients&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;myPatients&#39;</span><span class="p">))</span>
        
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;appointments&#39;</span><span class="p">))</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/appointmentDetails&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<div class="viewcode-block" id="appointmentAcceptDecline_view"><a class="viewcode-back" href="../../views.html#justHealthServer.views.appointmentAcceptDecline_view">[docs]</a><span class="k">def</span> <span class="nf">appointmentAcceptDecline_view</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Gets the correct appointment to show the patient, handles the accept or decline option on appointments that they have been invited to by their carer&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;GET&#39;</span><span class="p">:</span>
        <span class="n">appid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>
        <span class="n">getApp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAppointment</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="n">appid</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;appointmentAcceptDecline.html&#39;</span><span class="p">,</span> <span class="n">appointment</span><span class="o">=</span><span class="n">getApp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">acceptDeclineAppointment</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;action&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;appid&#39;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;action&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Accept&quot;</span><span class="p">:</span>
            <span class="n">messageType</span> <span class="o">=</span> <span class="s">&#39;success&#39;</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">messageType</span> <span class="o">=</span> <span class="s">&#39;danger&#39;</span>

        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s">&quot;Failed&quot;</span><span class="p">:</span> 
            <span class="n">messageType</span> <span class="o">=</span> <span class="s">&#39;danger&#39;</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s">&quot;You have not been invited to this appointment.&quot;</span><span class="p">:</span> 
            <span class="n">messageType</span> <span class="o">=</span> <span class="s">&#39;danger&#39;</span>

        <span class="n">getApp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAppointment</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;appid&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;appointmentAcceptDecline.html&#39;</span><span class="p">,</span> <span class="n">appointment</span><span class="o">=</span><span class="n">getApp</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">messageType</span><span class="p">)</span>

</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/myPatients&#39;</span><span class="p">)</span>
<span class="nd">@needLogin</span>
<div class="viewcode-block" id="myPatients"><a class="viewcode-back" href="../../views.html#justHealthServer.views.myPatients">[docs]</a><span class="k">def</span> <span class="nf">myPatients</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Shows carer page listing their connected patients, they can edit each patient&#39;s prescriptions and appointments from here&quot;&quot;&quot;</span>
    <span class="c"># Get Patients</span>
    <span class="k">if</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Carer&#39;</span><span class="p">:</span>
        <span class="c"># Get all patients connected to this user</span>
        <span class="n">connections</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getConnections</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
        <span class="n">completedConnections</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">connections</span><span class="p">[</span><span class="s">&#39;completed&#39;</span><span class="p">])</span>
        <span class="n">patients</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">completedConnections</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">connection</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Patient&quot;</span><span class="p">:</span>
                <span class="n">patients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
    <span class="c"># Get all appointments</span>
    <span class="n">appointmentsMapping</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c"># Get all prescriptions</span>
    <span class="n">activePrescriptions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">upcomingPrescriptions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">expiredPrescriptions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">patient</span> <span class="ow">in</span> <span class="n">patients</span><span class="p">:</span>
        <span class="n">appointmentsMapping</span><span class="p">[</span><span class="n">patient</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAllAppointments</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="n">patient</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>

        <span class="n">activePrescriptions</span><span class="p">[</span><span class="n">patient</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getActivePrescriptions</span><span class="p">(</span><span class="n">patient</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
        <span class="n">upcomingPrescriptions</span><span class="p">[</span><span class="n">patient</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getUpcomingPrescriptions</span><span class="p">(</span><span class="n">patient</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
        <span class="n">expiredPrescriptions</span><span class="p">[</span><span class="n">patient</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getExpiredPrescriptions</span><span class="p">(</span><span class="n">patient</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;myPatients.html&#39;</span><span class="p">,</span> <span class="n">patients</span> <span class="o">=</span> <span class="n">patients</span><span class="p">,</span> <span class="n">appointmentsMapping</span> <span class="o">=</span> <span class="n">appointmentsMapping</span><span class="p">,</span> <span class="n">activePrescriptions</span> <span class="o">=</span> <span class="n">activePrescriptions</span><span class="p">,</span> <span class="n">upcomingPrescriptions</span> <span class="o">=</span> <span class="n">upcomingPrescriptions</span><span class="p">,</span> <span class="n">expiredPrescriptions</span> <span class="o">=</span> <span class="n">expiredPrescriptions</span><span class="p">,</span> <span class="n">medicationList</span> <span class="o">=</span> <span class="n">Medication</span><span class="o">.</span><span class="n">select</span><span class="p">())</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/prescriptions&#39;</span><span class="p">)</span>
<span class="nd">@needLogin</span>
<div class="viewcode-block" id="prescriptions"><a class="viewcode-back" href="../../views.html#justHealthServer.views.prescriptions">[docs]</a><span class="k">def</span> <span class="nf">prescriptions</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Shows all the active prescriptions for the patient selected&quot;&quot;&quot;</span>
    <span class="n">prescriptions</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getPrescriptions</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;prescriptions.html&#39;</span><span class="p">,</span> <span class="n">prescriptions</span> <span class="o">=</span> <span class="n">prescriptions</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/deletePrescription&#39;</span><span class="p">)</span>
<span class="nd">@needLogin</span>
<div class="viewcode-block" id="deletePrescription_view"><a class="viewcode-back" href="../../views.html#justHealthServer.views.deletePrescription_view">[docs]</a><span class="k">def</span> <span class="nf">deletePrescription_view</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Informs Carer that the prescription has been deleted from the selected patient&quot;&quot;&quot;</span>
    <span class="n">prescriptionid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>
    <span class="n">prescription</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">prescriptionid</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">deletePrescription</span><span class="p">(</span><span class="n">prescriptionid</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="s">&quot;Failed&quot;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s">&quot;Deleted &quot;</span> <span class="o">+</span> <span class="n">prescription</span><span class="o">.</span><span class="n">medication</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">prescription</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;x&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">prescription</span><span class="o">.</span><span class="n">dosage</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;) &quot;</span> <span class="o">+</span> <span class="n">prescription</span><span class="o">.</span><span class="n">dosageunit</span> <span class="o">+</span> <span class="s">&quot; for &quot;</span> <span class="o">+</span> <span class="n">username</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&#39;result&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&#39;success&#39;</span><span class="p">,</span> <span class="s">&#39;class&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&#39;prescription&#39;</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;myPatients&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&#39;prescription&#39;</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&#39;danger&#39;</span><span class="p">,</span> <span class="s">&#39;class&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&#39;result&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;myPatients&#39;</span><span class="p">))</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/addPrescription&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<div class="viewcode-block" id="addPrescription_view"><a class="viewcode-back" href="../../views.html#justHealthServer.views.addPrescription_view">[docs]</a><span class="k">def</span> <span class="nf">addPrescription_view</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Informs Carer that the prescription has been added to the selected patient&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">addPrescription</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="s">&quot;Failed&quot;</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&#39;result&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&#39;success&#39;</span><span class="p">,</span> <span class="s">&#39;class&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&#39;prescription&#39;</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;myPatients&#39;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">result</span> <span class="o">==</span> <span class="s">&quot;Data is in the wrong format&quot;</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&#39;prescription&#39;</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&#39;danger&#39;</span><span class="p">,</span> <span class="s">&#39;class&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&#39;result&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;myPatients&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&#39;prescription&#39;</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&#39;danger&#39;</span><span class="p">,</span> <span class="s">&#39;class&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&#39;result&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;myPatients&#39;</span><span class="p">))</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/updatePrescription&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<div class="viewcode-block" id="updatePrescription_view"><a class="viewcode-back" href="../../views.html#justHealthServer.views.updatePrescription_view">[docs]</a><span class="k">def</span> <span class="nf">updatePrescription_view</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Informs Carer that the prescription has been updated for the selected patient&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">editPrescription</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="s">&quot;Failed&quot;</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&#39;result&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&#39;success&#39;</span><span class="p">,</span> <span class="s">&#39;class&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&#39;prescription&#39;</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;myPatients&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&#39;prescription&#39;</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&#39;danger&#39;</span><span class="p">,</span> <span class="s">&#39;class&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&#39;result&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;myPatients&#39;</span><span class="p">))</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/takePrescriptionWeb&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<span class="k">def</span> <span class="nf">takePrescriptionWeb</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">takePrescription</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/getPrescriptionCountWeb&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<span class="k">def</span> <span class="nf">getPrescriptionCountWeb</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">getPrescriptionCount</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/carerAppointments&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<div class="viewcode-block" id="carerappointments"><a class="viewcode-back" href="../../views.html#justHealthServer.views.carerappointments">[docs]</a><span class="k">def</span> <span class="nf">carerappointments</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Form for carer to add a personal appointment, this is not shown to patients.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>  
        <span class="n">private</span> <span class="o">=</span> <span class="s">&quot;True&quot;</span>
        <span class="n">details</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;creator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;apptype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;apptype&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;addressnamenumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;addressnamenumber&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;postcode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;postcode&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;endtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;endtime&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;private&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">private</span> 

        <span class="n">added</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">addPatientAppointment</span><span class="p">(</span><span class="n">details</span><span class="p">))</span>
  
        <span class="c">#checks that an id is returned</span>
        <span class="k">if</span> <span class="n">added</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> 
            <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Appointment Added&quot;</span><span class="p">,</span> <span class="s">&#39;success&#39;</span><span class="p">)</span>
    <span class="n">upcoming</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAllAppointments</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;carerAppointments.html&#39;</span><span class="p">,</span> <span class="n">appType</span><span class="o">=</span><span class="n">Appointmenttype</span><span class="o">.</span><span class="n">select</span><span class="p">(),</span> <span class="n">appointments</span><span class="o">=</span><span class="n">upcoming</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/inviteeappointments&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<div class="viewcode-block" id="inviteeappointments"><a class="viewcode-back" href="../../views.html#justHealthServer.views.inviteeappointments">[docs]</a><span class="k">def</span> <span class="nf">inviteeappointments</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Form for carer to add an appointment with a specific patient they are connected with, this will show on the patient&#39;s calendar.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
  
        <span class="n">details</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;creator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;apptype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;apptype&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;addressnamenumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;addressnamenumber&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;postcode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;postcode&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;endtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;endtime&#39;</span><span class="p">]</span>
        <span class="n">details</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]</span>
    
        <span class="n">added</span> <span class="o">=</span> <span class="n">addInviteeAppointment</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
      
        <span class="k">if</span> <span class="n">added</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> 
            <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Appointment Added&quot;</span><span class="p">,</span> <span class="s">&#39;success&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;appointments&#39;</span><span class="p">))</span>        
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;myPatients.html&#39;</span><span class="p">,</span> <span class="n">appType</span><span class="o">=</span><span class="n">Appointmenttype</span><span class="o">.</span><span class="n">select</span><span class="p">(),</span> <span class="n">appointments</span><span class="o">=</span><span class="n">appointments</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/nhsSearch&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<div class="viewcode-block" id="searchNHS"><a class="viewcode-back" href="../../views.html#justHealthServer.views.searchNHS">[docs]</a><span class="k">def</span> <span class="nf">searchNHS</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;The POST request is no longer needed as this is done with Javascript&quot;&quot;&quot;</span>
    <span class="c"># if request.method == &#39;POST&#39;:</span>
    <span class="c">#     website = searchNHSDirect(request.form[&#39;searchterm&#39;])</span>
    <span class="c">#     webbrowser.open(website,new=2)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;searchNHSDirect.html&#39;</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/dismissNotification&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<span class="k">def</span> <span class="nf">dismissNotifications</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Dismiss the notification by running a method from the API&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">notificationDismiss</span> <span class="o">=</span> <span class="n">dismissNotification</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;notificationid&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">notificationDismiss</span> 


<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/notes&#39;</span><span class="p">,</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<div class="viewcode-block" id="notes"><a class="viewcode-back" href="../../views.html#justHealthServer.views.notes">[docs]</a><span class="k">def</span> <span class="nf">notes</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;JustHealth correspondence, shows notes between a patient and their carer&quot;&quot;&quot;</span>
    <span class="n">connections</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getConnections</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]))</span>    
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;GET&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Get the notes for the patient and carer that are connected</span>
            <span class="n">patient</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;user&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">Patientcarer</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">Patientcarer</span><span class="o">.</span><span class="n">carer</span> <span class="o">==</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Patientcarer</span><span class="o">.</span><span class="n">patient</span> <span class="o">==</span> <span class="n">patient</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">correspondence</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getCorrespondence</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="n">patient</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;correspondence.html&#39;</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="n">correspondence</span><span class="p">,</span> <span class="n">patient</span><span class="o">=</span><span class="n">patient</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Patientcarer</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="c"># Patient/Carer relationship that&#39;s requested does not exist</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/addNote&#39;</span><span class="p">,</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<div class="viewcode-block" id="addNote"><a class="viewcode-back" href="../../views.html#justHealthServer.views.addNote">[docs]</a><span class="k">def</span> <span class="nf">addNote</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Correspondence page, handles the form POST request to store a note between patient and carer&quot;&quot;&quot;</span>
    <span class="n">patient</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;patient&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">addCorrespondence</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Note successfully added&quot;</span><span class="p">,</span> <span class="s">&#39;success&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Note could not be added&quot;</span><span class="p">,</span> <span class="s">&#39;danger&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">&quot;/notes?user=&quot;</span> <span class="o">+</span> <span class="n">patient</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/deleteNote&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<div class="viewcode-block" id="deleteNote_view"><a class="viewcode-back" href="../../views.html#justHealthServer.views.deleteNote_view">[docs]</a><span class="k">def</span> <span class="nf">deleteNote_view</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Correspondence page, handles the POST request from the delete button to remove the correct note from the database&quot;&quot;&quot;</span>
    <span class="n">patient</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;patient&#39;</span><span class="p">]</span>
    <span class="n">noteid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;noteid&#39;</span><span class="p">]</span>
    <span class="n">deleted</span> <span class="o">=</span> <span class="n">deleteNote</span><span class="p">(</span><span class="n">noteid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">deleted</span> <span class="o">==</span> <span class="s">&quot;Deleted&quot;</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Note successfully deleted&quot;</span><span class="p">,</span> <span class="s">&#39;success&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Note could not be deleted&quot;</span><span class="p">,</span> <span class="s">&#39;danger&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">&quot;/notes?user=&quot;</span> <span class="o">+</span> <span class="n">patient</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/patientNotes&#39;</span><span class="p">,</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">patientNotes</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;GET&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">notes</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getPatientNotes</span><span class="p">(</span><span class="n">session</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;patientNotes.html&#39;</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="n">notes</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Patientcarer</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;patientNotes.html&#39;</span><span class="p">)</span>

<span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">internal_error</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;internalError.html&#39;</span><span class="p">),</span> <span class="mi">500</span>

<span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">408</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">internal_error</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;internalError.html&#39;</span><span class="p">),</span> <span class="mi">408</span>

<span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">internal_error</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;404Error.html&#39;</span><span class="p">),</span> <span class="mi">404</span>

<span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">internal_error</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
  <span class="k">return</span> <span class="s">&quot;Your request appears to be malformed&quot;</span><span class="p">,</span> <span class="mi">400</span>

<span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span>
<div class="viewcode-block" id="internal_error"><a class="viewcode-back" href="../../views.html#justHealthServer.views.internal_error">[docs]</a><span class="k">def</span> <span class="nf">internal_error</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
  <span class="k">return</span> <span class="s">&quot;Unauthorised&quot;</span><span class="p">,</span> <span class="mi">401</span>

<span class="c">#Admin Portal pages</span></div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/adminPortal&#39;</span><span class="p">)</span>
<span class="nd">@needLogin</span>
<span class="nd">@needAdmin</span>
<div class="viewcode-block" id="adminPortal"><a class="viewcode-back" href="../../views.html#justHealthServer.views.adminPortal">[docs]</a><span class="k">def</span> <span class="nf">adminPortal</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Loads the pages related to the tablist on the IM portal home page, this includes a list of active users, current medication list and deactivation options&quot;&quot;&quot;</span>
    <span class="n">allUsers</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAllUsers</span><span class="p">())</span>
    <span class="n">deactivateReasons</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getReasons</span><span class="p">())</span>
    <span class="n">carers</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Carer</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Carer</span><span class="o">.</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()))</span>
    <span class="n">patients</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Patient</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Patient</span><span class="o">.</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()))</span>     
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">deactivateAccount</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">allUsers</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Patient&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;adminHome.html&#39;</span><span class="p">,</span> <span class="n">reasons</span> <span class="o">=</span> <span class="n">Deactivatereason</span><span class="o">.</span><span class="n">select</span><span class="p">(),</span> <span class="n">reasonStats</span> <span class="o">=</span> <span class="n">deactivateReasons</span><span class="p">,</span> <span class="n">allUsers</span> <span class="o">=</span> <span class="n">allUsers</span><span class="p">,</span> <span class="n">printaccounttype</span> <span class="o">=</span> <span class="s">&#39;Patient&#39;</span><span class="p">,</span> <span class="n">medicationList</span> <span class="o">=</span> <span class="n">Medication</span><span class="o">.</span><span class="n">select</span><span class="p">(),</span> <span class="n">carers</span> <span class="o">=</span> <span class="n">carers</span><span class="p">,</span> <span class="n">patients</span> <span class="o">=</span> <span class="n">patients</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
       <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;adminHome.html&#39;</span><span class="p">,</span> <span class="n">reasons</span> <span class="o">=</span> <span class="n">Deactivatereason</span><span class="o">.</span><span class="n">select</span><span class="p">(),</span> <span class="n">reasonStats</span> <span class="o">=</span> <span class="n">deactivateReasons</span><span class="p">,</span> <span class="n">allUsers</span> <span class="o">=</span> <span class="n">allUsers</span><span class="p">,</span> <span class="n">printaccounttype</span> <span class="o">=</span> <span class="s">&#39;Carer&#39;</span><span class="p">,</span> <span class="n">medicationList</span> <span class="o">=</span> <span class="n">Medication</span><span class="o">.</span><span class="n">select</span><span class="p">(),</span> <span class="n">carers</span> <span class="o">=</span> <span class="n">carers</span><span class="p">,</span> <span class="n">patients</span> <span class="o">=</span> <span class="n">patients</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/updateAccountSettings_view&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<span class="nd">@needAdmin</span>
<span class="k">def</span> <span class="nf">updateAccountSettings_view</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="c">#The tick boxes are not sent if they aren&#39;t ticked, so we have to catch them here.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">accountdeactivated</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;accountdeactivated&#39;</span><span class="p">]</span>
            <span class="n">accountdeactivated</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">accountdeactivated</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">accountlocked</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;accountlocked&#39;</span><span class="p">]</span>
            <span class="n">accountlocked</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">accountlocked</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">try</span><span class="p">:</span>       
            <span class="n">verified</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;verified&#39;</span><span class="p">]</span>
            <span class="n">verified</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">verified</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">updateAccountSettings</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">,</span> <span class="n">accountlocked</span><span class="p">,</span> <span class="n">accountdeactivated</span><span class="p">,</span> <span class="n">verified</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">&#39;Account Settings Updated&#39;</span><span class="p">,</span> <span class="s">&#39;success&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;adminPortal&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">&#39;Update failed&#39;</span><span class="p">,</span> <span class="s">&#39;danger&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;adminPortal&#39;</span><span class="p">))</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/deleteAccount&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<span class="nd">@needAdmin</span>
<div class="viewcode-block" id="deleteAccount_view"><a class="viewcode-back" href="../../views.html#justHealthServer.views.deleteAccount_view">[docs]</a><span class="k">def</span> <span class="nf">deleteAccount_view</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Submits the form for an administrator to delete a user account from the management portal&quot;&quot;&quot;</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
    <span class="n">deleted</span> <span class="o">=</span> <span class="n">deleteAccount</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">deleted</span> <span class="o">==</span> <span class="s">&quot;Deleted&quot;</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&quot;User successfully deleted&quot;</span><span class="p">,</span> <span class="s">&#39;success&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&quot;User could not be deleted&quot;</span><span class="p">,</span> <span class="s">&#39;danger&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">&quot;/adminPortal&quot;</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/addNewDeactivate&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<span class="nd">@needAdmin</span>
<div class="viewcode-block" id="addNewDeactivate"><a class="viewcode-back" href="../../views.html#justHealthServer.views.addNewDeactivate">[docs]</a><span class="k">def</span> <span class="nf">addNewDeactivate</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Submits the form to add a new deactivation reason to the database&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">addDeactivate</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>  
        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;adminHome.html&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s">&quot;success&quot;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;Deactivate Reason Added&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;adminHome.html&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s">&quot;warning&quot;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;Update failed&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
       <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;adminHome.html&#39;</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/addNewMedication&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@needLogin</span>
<span class="nd">@needAdmin</span>
<div class="viewcode-block" id="addNewMedication"><a class="viewcode-back" href="../../views.html#justHealthServer.views.addNewMedication">[docs]</a><span class="k">def</span> <span class="nf">addNewMedication</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Submits the form to add a new medication name to the database&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">newMedication</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>  
        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;adminHome.html&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s">&quot;success&quot;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;Medication Added&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;adminHome.html&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s">&quot;warning&quot;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;Update failed&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>   
       <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;adminHome.html&#39;</span><span class="p">)</span>
</div>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/test&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">addReminders</span><span class="p">(</span><span class="s">&#39;sophie15&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Charlotte Hutchinson, Rich Logan, Ben McGregor, Stephen Tate.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>