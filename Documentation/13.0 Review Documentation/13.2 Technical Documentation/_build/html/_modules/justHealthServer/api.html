

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>justHealthServer.api &mdash; JustHealth 1 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="JustHealth 1 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../index.html" class="fa fa-home"> JustHealth</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../examiner.html">Examiners Guide to JustHealth</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../examiner.html#website">Website</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examiner.html#android">Android</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examiner.html#testing-portal">Testing Portal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examiner.html#documentation">Documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../arch.html">Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../arch.html#overall-structure">Overall Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../arch.html#the-api-server">The API server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../arch.html#the-orm">The ORM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../arch.html#the-database">The Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../arch.html#the-web-application">The Web application</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../arch.html#the-android-application">The Android application</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../arch.html#documentation">Documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../development.html">Development</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../development.html#general-development-process">General Development Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../development.html#development-tools">Development Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../development.html#testing">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../development.html#automated-api-tests">Automated API Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../development.html#runtests-sh">runTests.sh</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Full API Listing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-justHealthServer.api">Accounts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../views.html">Full Views Listing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#user-login">User Login</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#register">Register</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#search">Search</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#deactivate">Deactivate</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#user-logout">User Logout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#user-verification">User Verification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#forgot-password">Forgot Password</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#password-reset">Password Reset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#appointments">Appointments</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#my-patients">My Patients</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#prescriptions">Prescriptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#connections">Connections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#notes">Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#contact-us">Contact Us</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#error-handling">Error Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../views.html#justhealth-admin-portal">JustHealth Admin Portal</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../users.html">User Functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../database.html">Database</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../database.html#module-justHealthServer.database">Client</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../html.html">HTML Listing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#frontpage-html">frontpage.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#login-html">login.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#register-html">register.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#dashboard-html">dashboard.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#dashboardcarer-html">dashboardCarer.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#editprofile-html">editProfile.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#deactivate-html">deactivate.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#search-html">search.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#changepassword-html">changePassword.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#resetpassword-html">resetpassword.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#resetpasswordnowquestion-html">resetpasswordnowquestion.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#expiredpassword-html">expiredpassword.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#mypatients-html">myPatients.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#carerappointments-html">carerAppointments.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#patientappointments-html">patientAppointments.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#patientupdateappointment-html">patientUpdateAppointment.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#prescriptions-html">prescriptions.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#correspondence-html">correspondence.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#patientnotes-html">patientNotes.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#contactus-html">contactUs.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#faq-html">faq.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#template-html">template.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#searchnhsdirect-html">searchNHSDirect.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#settings-html">settings.html</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#error-pages">error pages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../html.html#admin-pages">Admin Pages</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../security.html">Security Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../security.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security.html#https">HTTPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security.html#password-security">Password Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security.html#api-authentication">API Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security.html#sql-injection">SQL Injection</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">JustHealth</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>justHealthServer.api</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <h1>Source code for justHealthServer.api</h1><div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">justHealthServer</span> <span class="kn">import</span> <span class="n">app</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">abort</span><span class="p">,</span> <span class="n">send_from_directory</span><span class="p">,</span> <span class="n">request_started</span>
<span class="kn">from</span> <span class="nn">flask.ext.httpauth</span> <span class="kn">import</span> <span class="n">HTTPBasicAuth</span>
<span class="c"># Line 5 !!!MUST!!! be the database import in order for /runTests.sh to work. Please do not change without also altering /runTests.sh</span>
<span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">gcm</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">itsdangerous</span> <span class="kn">import</span> <span class="n">URLSafeSerializer</span><span class="p">,</span> <span class="n">BadSignature</span>
<span class="kn">from</span> <span class="nn">passlib.hash</span> <span class="kn">import</span> <span class="n">sha256_crypt</span>
<span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">secure_filename</span>
<span class="c">#used to encrypt and decrypt the password in the method encryptPassword() and decryptPassword()</span>
<span class="kn">from</span> <span class="nn">simplecrypt</span> <span class="kn">import</span> <span class="n">encrypt</span><span class="p">,</span> <span class="n">decrypt</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">smtplib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">base64</span>

<span class="n">auth</span> <span class="o">=</span> <span class="n">HTTPBasicAuth</span><span class="p">()</span>

<span class="nd">@auth.verify_password</span>
<div class="viewcode-block" id="verify_password"><a class="viewcode-back" href="../../api.html#justHealthServer.api.verify_password">[docs]</a><span class="k">def</span> <span class="nf">verify_password</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks if the password entered is the current password for that account&quot;&quot;&quot;</span>
    <span class="n">plaintextPassword</span> <span class="o">=</span> <span class="n">decryptPassword</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hashedPassword</span> <span class="o">=</span> <span class="n">uq8LnAWi7D</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">uq8LnAWi7D</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">uq8LnAWi7D</span><span class="o">.</span><span class="n">iscurrent</span><span class="o">==</span><span class="bp">True</span><span class="p">))</span><span class="o">.</span><span class="n">password</span>
        <span class="k">return</span> <span class="n">sha256_crypt</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plaintextPassword</span><span class="p">,</span> <span class="n">hashedPassword</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="getUsernameFromHeader"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getUsernameFromHeader">[docs]</a><span class="k">def</span> <span class="nf">getUsernameFromHeader</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Method gets the HTTP Basic header, decodes it and gets the username&quot;&quot;&quot;</span>
    <span class="n">authHeader</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Authorization&#39;</span><span class="p">))</span>
    <span class="n">authHeader</span> <span class="o">=</span> <span class="n">authHeader</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;Basic &quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="n">decodedAuthHeader</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">authHeader</span><span class="p">)</span>
    <span class="n">authUsername</span> <span class="o">=</span> <span class="n">decodedAuthHeader</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">authUsername</span>
</div>
<div class="viewcode-block" id="verifyContentRequest"><a class="viewcode-back" href="../../api.html#justHealthServer.api.verifyContentRequest">[docs]</a><span class="k">def</span> <span class="nf">verifyContentRequest</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">targetUsername</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This co-ordinated the running of the other methods, depending on the parameters that are passed&quot;&quot;&quot;</span>
    <span class="sd">&quot;&quot;&quot;This method can be called from anywhere and if the method is retrieving records for the same person that is authenticated targetUsername should be sent accross as an empty string&quot;&quot;&quot;</span>
    <span class="n">authUsername</span> <span class="o">=</span> <span class="n">getUsernameFromHeader</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">targetUsername</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">verifySelf</span><span class="p">(</span><span class="n">authUsername</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">verifySelf</span><span class="p">(</span><span class="n">authUsername</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">verifyCarer</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">targetUsername</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="verifySelf"><a class="viewcode-back" href="../../api.html#justHealthServer.api.verifySelf">[docs]</a><span class="k">def</span> <span class="nf">verifySelf</span><span class="p">(</span><span class="n">authUsername</span><span class="p">,</span> <span class="n">methodUsername</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks that the user authenticated by HTTP Basic is the same as user that is associated with the records being read/written&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">authUsername</span> <span class="o">==</span> <span class="n">methodUsername</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="verifyCarer"><a class="viewcode-back" href="../../api.html#justHealthServer.api.verifyCarer">[docs]</a><span class="k">def</span> <span class="nf">verifyCarer</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">targetUsername</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks that the user authenticated by HTTP Basic is connected to the user that is associated with the records being read/written&quot;&quot;&quot;</span>
    <span class="n">accountInfo</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">accountInfo</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Carer&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">getConnectionStatus</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">targetUsername</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;Already Connected&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/api/encryptPassword&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;POST&quot;</span><span class="p">])</span>
<div class="viewcode-block" id="encryptPassword"><a class="viewcode-back" href="../../api.html#justHealthServer.api.encryptPassword">[docs]</a><span class="k">def</span> <span class="nf">encryptPassword</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Encrypts the users password and returns it to them&quot;&quot;&quot;</span>
    <span class="c">#used so that we are able to store the encrypted users password in android SharedPreferences</span>
    <span class="n">plaintext</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">]</span>
    <span class="n">cipherText</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">plaintext</span><span class="p">)</span>
    <span class="n">stringCipher</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">cipherText</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stringCipher</span>
</div>
<div class="viewcode-block" id="decryptPassword"><a class="viewcode-back" href="../../api.html#justHealthServer.api.decryptPassword">[docs]</a><span class="k">def</span> <span class="nf">decryptPassword</span><span class="p">(</span><span class="n">cipherText</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decrypts the users password and returns it so that we are able to authenticate them&quot;&quot;&quot;</span>
    <span class="c">#used so that we are able to store the encrypted users password in android SharedPreferences</span>
    <span class="n">bytesCipher</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">cipherText</span><span class="p">)</span>
    <span class="n">plaintext</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">bytesCipher</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plaintext</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/api/registerUser&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;POST&quot;</span><span class="p">])</span>
<div class="viewcode-block" id="registerUser"><a class="viewcode-back" href="../../api.html#justHealthServer.api.registerUser">[docs]</a><span class="k">def</span> <span class="nf">registerUser</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Builds the user profile using the information input in the form&quot;&quot;&quot;</span>
    <span class="c"># Build User Registration</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">profile</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">profile</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
      <span class="n">profile</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">]</span>
      <span class="n">profile</span><span class="p">[</span><span class="s">&#39;surname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;surname&#39;</span><span class="p">]</span>
      <span class="n">profile</span><span class="p">[</span><span class="s">&#39;dob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;dob&#39;</span><span class="p">]</span>
      <span class="n">profile</span><span class="p">[</span><span class="s">&#39;ismale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;ismale&#39;</span><span class="p">]</span>
      <span class="n">profile</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span>
      <span class="n">profile</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">]</span>
      <span class="n">profile</span><span class="p">[</span><span class="s">&#39;confirmpassword&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;confirmpassword&#39;</span><span class="p">]</span>
      <span class="n">accountType</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span>
      <span class="n">profile</span><span class="p">[</span><span class="s">&#39;profilepicture&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;default.png&quot;</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">return</span> <span class="s">&quot;All fields must be filled out&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">profile</span><span class="p">[</span><span class="s">&#39;terms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;terms&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">return</span> <span class="s">&quot;Terms and Conditions must be accepted&quot;</span>

    <span class="c"># Validate all input</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c"># Validate username &gt;25</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">25</span><span class="p">:</span>
      <span class="k">return</span> <span class="s">&quot;Username can not be longer than 25 characters&quot;</span>

    <span class="k">if</span> <span class="n">Client</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
       <span class="k">return</span> <span class="s">&quot;Username already taken&quot;</span>

    <span class="c"># Validate firstname, surname and email &gt;25</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s">&#39;surname&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
      <span class="k">return</span> <span class="s">&#39;Firstname, surname and email can not be longer than 100 characters&#39;</span>

    <span class="c"># Validate email correct format</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="s">&#39;^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,4})$&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]):</span>
      <span class="k">return</span> <span class="s">&quot;Email failed validation&quot;</span>

    <span class="c"># Encrypt password with SHA 256</span>
    <span class="n">profile</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sha256_crypt</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">])</span>

    <span class="n">isMale</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;ismale&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">:</span>
        <span class="n">isMale</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c">#Check for existing username</span>
    <span class="k">if</span> <span class="n">Client</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">return</span> <span class="s">&quot;Username already taken&quot;</span>
    <span class="k">if</span> <span class="n">Client</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">return</span> <span class="s">&quot;Email address already taken&quot;</span>

    <span class="c"># Build insert user query</span>
    <span class="n">userInsert</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
      <span class="n">username</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span>
      <span class="n">dob</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;dob&#39;</span><span class="p">],</span>
      <span class="n">email</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">],</span>
      <span class="n">accountdeactivated</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
      <span class="n">accountlocked</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
      <span class="n">loginattempts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="n">verified</span>  <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
      <span class="n">profilepicture</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;profilepicture&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">accountType</span> <span class="o">==</span> <span class="s">&quot;patient&quot;</span><span class="p">:</span>
        <span class="n">accountType</span> <span class="o">=</span> <span class="n">Patient</span>
    <span class="k">elif</span> <span class="n">accountType</span> <span class="o">==</span> <span class="s">&quot;carer&quot;</span><span class="p">:</span>
        <span class="n">accountType</span> <span class="o">=</span> <span class="n">Carer</span>
    <span class="k">elif</span> <span class="n">accountType</span> <span class="o">==</span> <span class="s">&quot;Admin&quot;</span><span class="p">:</span>
        <span class="n">accountType</span> <span class="o">=</span> <span class="n">Admin</span>

    <span class="n">typeInsert</span> <span class="o">=</span> <span class="n">accountType</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span>
        <span class="n">firstname</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">],</span>
        <span class="n">surname</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;surname&#39;</span><span class="p">],</span>
        <span class="n">ismale</span> <span class="o">=</span> <span class="n">isMale</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c"># Build insert password query</span>
    <span class="n">userPassword</span> <span class="o">=</span> <span class="n">uq8LnAWi7D</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
      <span class="n">username</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span>
      <span class="n">password</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">],</span>
      <span class="n">iscurrent</span> <span class="o">=</span> <span class="s">&#39;TRUE&#39;</span><span class="p">,</span>
      <span class="n">expirydate</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">90</span><span class="p">))</span>
    <span class="p">)</span>


    <span class="c"># Execute Queries</span>
    <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
        <span class="n">userInsert</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="n">typeInsert</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="n">userPassword</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="n">sendVerificationEmail</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="s">&quot;True&quot;</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/usernameCheck&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<div class="viewcode-block" id="usernameCheck"><a class="viewcode-back" href="../../api.html#justHealthServer.api.usernameCheck">[docs]</a><span class="k">def</span> <span class="nf">usernameCheck</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns True if a username has already been taken&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/authenticate&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<div class="viewcode-block" id="authenticate"><a class="viewcode-back" href="../../api.html#justHealthServer.api.authenticate">[docs]</a><span class="k">def</span> <span class="nf">authenticate</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Authenticates a username and password and returns the result of the authentication check&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">attempted</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="n">Client</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;Incorrect username/password&quot;</span>

    <span class="c"># Check Password</span>
    <span class="k">try</span><span class="p">:</span> 
        <span class="n">hashedPassword</span> <span class="o">=</span> <span class="n">uq8LnAWi7D</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">uq8LnAWi7D</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">attempted</span><span class="o">.</span><span class="n">username</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">uq8LnAWi7D</span><span class="o">.</span><span class="n">iscurrent</span><span class="o">==</span><span class="bp">True</span><span class="p">))</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">uq8LnAWi7D</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;There is no current password for this username. Please use the forgot password link to reset your account.&quot;</span>
    <span class="n">attemptedPassword</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">sha256_crypt</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">attemptedPassword</span><span class="p">,</span> <span class="n">hashedPassword</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attempted</span><span class="o">.</span><span class="n">accountdeactivated</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;Account deactivated&quot;</span>
        <span class="k">elif</span> <span class="n">attempted</span><span class="o">.</span><span class="n">verified</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;Account not verified. Please check your email for instructions&quot;</span>
        <span class="k">elif</span> <span class="n">attempted</span><span class="o">.</span><span class="n">accountlocked</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;Account is locked. Please check your email for instructions&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">revertAttempts</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loginattempts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">attempted</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                <span class="n">revertAttempts</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                <span class="c">#Password expiry methods need to be added here</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">passwordExpiration</span><span class="p">(</span><span class="n">attempted</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">status</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">currentLoginAttempts</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">attempted</span><span class="o">.</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">loginattempts</span>
        <span class="k">if</span> <span class="n">currentLoginAttempts</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">lockAccount</span><span class="p">(</span><span class="n">attempted</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
            <span class="n">incrementAttempts</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loginattempts</span> <span class="o">=</span> <span class="p">(</span><span class="n">currentLoginAttempts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">attempted</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
            <span class="n">incrementAttempts</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="k">return</span> <span class="s">&quot;Account is locked. Please check your email for instructions&quot;</span>
        <span class="n">incrementAttempts</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loginattempts</span> <span class="o">=</span> <span class="p">(</span><span class="n">currentLoginAttempts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">attempted</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
            <span class="n">incrementAttempts</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&quot;Incorrect username/password&quot;</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/deactivateaccount&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">deactivateAccount</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">deactivateAccount</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>

<div class="viewcode-block" id="deactivateAccount"><a class="viewcode-back" href="../../api.html#justHealthServer.api.deactivateAccount">[docs]</a><span class="k">def</span> <span class="nf">deactivateAccount</span><span class="p">(</span><span class="n">details</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Form validation for account deactivation&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;No username supplied&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;deletecheckbox&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;on&quot;</span><span class="p">:</span>
            <span class="n">delete</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">delete</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">delete</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">comments</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;comments&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">comments</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;reason&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;Please select a reason&quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">Userdeactivatereason</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span><span class="p">,</span>
        <span class="n">comments</span> <span class="o">=</span> <span class="n">comments</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
        <span class="n">q</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">delete</span><span class="p">:</span>
        <span class="c"># Delete User</span>
        <span class="n">deleteAppointments</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">invitee</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>
        <span class="n">deletedUser</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>
        <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
            <span class="n">deleteAppointments</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="n">deletedUser</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&quot;Deleted&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Keep user</span>
        <span class="n">deactivatedUser</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">accountdeactivated</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span>
        <span class="n">unverifyUser</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">verified</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
            <span class="n">deactivatedUser</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="n">unverifyUser</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&quot;Kept&quot;</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/resetpassword&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<div class="viewcode-block" id="resetPassword"><a class="viewcode-back" href="../../api.html#justHealthServer.api.resetPassword">[docs]</a><span class="k">def</span> <span class="nf">resetPassword</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Form validation and database checks for user when they forget a password (overrides the old password)&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">profile</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
        <span class="n">profile</span><span class="p">[</span><span class="s">&#39;confirmemail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;confirmemail&#39;</span><span class="p">]</span>
        <span class="n">profile</span><span class="p">[</span><span class="s">&#39;newpassword&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;newpassword&#39;</span><span class="p">]</span>
        <span class="n">profile</span><span class="p">[</span><span class="s">&#39;confirmnewpassword&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;confirmnewpassword&#39;</span><span class="p">]</span>
        <span class="n">profile</span><span class="p">[</span><span class="s">&#39;confirmdob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;confirmdob&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;All fields must be filled out&quot;</span>

    <span class="n">getEmail</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">profile</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">getDob</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">profile</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dob</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">getEmail</span><span class="o">==</span><span class="n">profile</span><span class="p">[</span><span class="s">&#39;confirmemail&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">getDob</span><span class="o">==</span><span class="n">profile</span><span class="p">[</span><span class="s">&#39;confirmdob&#39;</span><span class="p">]:</span>
        <span class="c">#set the old password to iscurrent = false</span>
        <span class="n">notCurrent</span> <span class="o">=</span> <span class="n">uq8LnAWi7D</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">iscurrent</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">uq8LnAWi7D</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>
        <span class="n">notVerified</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">verified</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>

        <span class="c">#encrypt the password</span>
        <span class="n">profile</span><span class="p">[</span><span class="s">&#39;newpassword&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sha256_crypt</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s">&#39;newpassword&#39;</span><span class="p">])</span>

        <span class="c"># Build insert password query</span>
        <span class="n">newCredentials</span> <span class="o">=</span> <span class="n">uq8LnAWi7D</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
          <span class="n">username</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span>
          <span class="n">password</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;newpassword&#39;</span><span class="p">],</span>
          <span class="n">iscurrent</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
          <span class="n">expirydate</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">90</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">unlockAccount</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">accountlocked</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>
        <span class="n">setLoginCount</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loginattempts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>

        <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
            <span class="n">notCurrent</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="n">notVerified</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="n">newCredentials</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="n">unlockAccount</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="n">setLoginCount</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

        <span class="n">sendPasswordResetEmail</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="s">&quot;True&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>

<span class="c">####</span>
<span class="c"># Account Information</span>
<span class="c">####</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/images/&lt;filename&gt;&#39;</span><span class="p">)</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">getProfilePictureAPI</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;PROFILE_PICTURE&#39;</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/getAccountInfo&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">getAccountInfo</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">getAccountInfo</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span> 

<div class="viewcode-block" id="getAccountInfo"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getAccountInfo">[docs]</a><span class="k">def</span> <span class="nf">getAccountInfo</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get Account information from client and patient/carer table&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">user</span> <span class="o">=</span> <span class="n">Patient</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Client</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span><span class="o">==</span><span class="nb">str</span><span class="p">(</span><span class="n">username</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
      <span class="n">result</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Patient&quot;</span>
    <span class="k">except</span> <span class="n">Patient</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">Carer</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Client</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span><span class="o">==</span><span class="nb">str</span><span class="p">(</span><span class="n">username</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Carer&quot;</span>
        <span class="k">except</span> <span class="n">Carer</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">Admin</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Client</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span><span class="o">==</span><span class="nb">str</span><span class="p">(</span><span class="n">username</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Admin&quot;</span>

    <span class="n">result</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">firstname</span>
    <span class="n">result</span><span class="p">[</span><span class="s">&#39;surname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">surname</span>
    <span class="n">result</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">username</span>
    <span class="n">result</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">email</span>
    <span class="n">result</span><span class="p">[</span><span class="s">&#39;dob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">dob</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s">&#39;profilepicture&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">profilepicture</span>
    <span class="n">result</span><span class="p">[</span><span class="s">&#39;telephonenumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">telephonenumber</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">ismale</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;gender&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Male&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;gender&#39;</span><span class="p">]</span> <span class="o">=</span><span class="s">&#39;Female&#39;</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">getCarers</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">Patientcarer</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Patientcarer</span><span class="o">.</span><span class="n">patient</span> <span class="o">==</span> <span class="n">username</span><span class="p">):</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">carer</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/setProfilePicture&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">setProfilePicture</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">setProfilePicture</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">setProfilePicture</span><span class="p">(</span><span class="n">details</span><span class="p">):</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="s">&quot;/static/images/profilePictures&quot;</span>
    <span class="n">allowedExtension</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">&#39;txt&#39;</span><span class="p">,</span> <span class="s">&#39;pdf&#39;</span><span class="p">,</span> <span class="s">&#39;png&#39;</span><span class="p">,</span> <span class="s">&#39;jpg&#39;</span><span class="p">,</span> <span class="s">&#39;jpeg&#39;</span><span class="p">,</span> <span class="s">&#39;gif&#39;</span><span class="p">,</span> <span class="s">&#39;svg&#39;</span><span class="p">])</span>

    <span class="nb">file</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;image&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">file</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="nb">file</span><span class="o">.</span><span class="n">filename</span> <span class="ow">and</span> <span class="nb">file</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">allowedExtension</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">filename</span>
    <span class="k">return</span> <span class="bp">False</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/editProfile&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">editProfile</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">editProfile</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">editProfile</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">picture</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># What type of user are we dealing with?</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">Patient</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Client</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span><span class="o">==</span><span class="n">profile</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">Patient</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">Carer</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Client</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span><span class="o">==</span><span class="n">profile</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="c"># Access to their corresponding Client entry</span>
    <span class="n">clientObject</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="n">gender</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;ismale&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">:</span>
        <span class="n">gender</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c"># Update</span>
    <span class="n">user</span><span class="o">.</span><span class="n">firstname</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">]</span>
    <span class="n">user</span><span class="o">.</span><span class="n">surname</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;surname&#39;</span><span class="p">]</span>
    <span class="n">user</span><span class="o">.</span><span class="n">ismale</span> <span class="o">=</span> <span class="n">gender</span>
    <span class="n">clientObject</span><span class="o">.</span><span class="n">dob</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;dob&#39;</span><span class="p">]</span>
    <span class="n">clientObject</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span>

    <span class="c"># Profile Picture Upload</span>
    <span class="n">allowedExtension</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">&#39;txt&#39;</span><span class="p">,</span> <span class="s">&#39;pdf&#39;</span><span class="p">,</span> <span class="s">&#39;png&#39;</span><span class="p">,</span> <span class="s">&#39;jpg&#39;</span><span class="p">,</span> <span class="s">&#39;jpeg&#39;</span><span class="p">,</span> <span class="s">&#39;gif&#39;</span><span class="p">,</span> <span class="s">&#39;svg&#39;</span><span class="p">])</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="n">picture</span><span class="p">[</span><span class="s">&#39;image&#39;</span><span class="p">]</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">filename</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">filename</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">filename</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">fileExtension</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">file</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">and</span> <span class="n">fileExtension</span> <span class="ow">in</span> <span class="n">allowedExtension</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">getSerializer</span><span class="p">()</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">fileExtension</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;PROFILE_PICTURE&#39;</span><span class="p">],</span> <span class="n">filename</span><span class="p">))</span>
            <span class="n">clientObject</span><span class="o">.</span><span class="n">profilepicture</span> <span class="o">=</span> <span class="n">filename</span>

    <span class="c"># Execute Updated</span>
    <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
        <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">clientObject</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&quot;Edit Successful&quot;</span>
    <span class="k">return</span> <span class="s">&quot;Failed&quot;</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/changePassword&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">changePasswordAPI</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">changePasswordAPI</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>

<div class="viewcode-block" id="changePasswordAPI"><a class="viewcode-back" href="../../api.html#justHealthServer.api.changePasswordAPI">[docs]</a><span class="k">def</span> <span class="nf">changePasswordAPI</span><span class="p">(</span><span class="n">details</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Allows a user to change their password. POST [username, oldpassword, newpassword, confirmnewpassword]&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;newpassword&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;confirmnewpassword&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s">&quot;Passwords do not match&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">currentPassword</span> <span class="o">=</span> <span class="n">uq8LnAWi7D</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">uq8LnAWi7D</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">uq8LnAWi7D</span><span class="o">.</span><span class="n">iscurrent</span><span class="o">==</span><span class="bp">True</span><span class="p">))</span>
        <span class="c"># If old password is correct</span>
        <span class="k">if</span> <span class="n">sha256_crypt</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;oldpassword&#39;</span><span class="p">],</span> <span class="n">currentPassword</span><span class="o">.</span><span class="n">password</span><span class="p">):</span>
            <span class="c"># Invalidate Old Password</span>
            <span class="n">currentPassword</span><span class="o">.</span><span class="n">iscurrent</span> <span class="o">=</span> <span class="bp">False</span>
        
            <span class="c"># Insert New Password</span>
            <span class="n">newPassword</span> <span class="o">=</span> <span class="n">uq8LnAWi7D</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">username</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span>
                <span class="n">password</span> <span class="o">=</span> <span class="n">sha256_crypt</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;newpassword&#39;</span><span class="p">]),</span>
                <span class="n">iscurrent</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                <span class="n">expirydate</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">90</span><span class="p">))</span>
            <span class="p">)</span>

            <span class="c"># Execute</span>
            <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                <span class="n">currentPassword</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">newPassword</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                <span class="k">return</span> <span class="s">&quot;Password changed successfully&quot;</span>
            <span class="k">return</span> <span class="s">&quot;Failed&quot;</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;Incorrect password&quot;</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;User does not exist&quot;</span>

<span class="c">####</span>
<span class="c"># Account Helper Functions</span>
<span class="c">####</span>
</div>
<div class="viewcode-block" id="lockAccount"><a class="viewcode-back" href="../../api.html#justHealthServer.api.lockAccount">[docs]</a><span class="k">def</span> <span class="nf">lockAccount</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Emails the user if their account gets locked&quot;&quot;&quot;</span>
    <span class="n">lockAccount</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">accountlocked</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
        <span class="n">lockAccount</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
    <span class="n">sendUnlockEmail</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="c">####</span>
<span class="c"># Email Functions</span>
<span class="c">####</span></div>
<div class="viewcode-block" id="getSerializer"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getSerializer">[docs]</a><span class="k">def</span> <span class="nf">getSerializer</span><span class="p">(</span><span class="n">secret_key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a username into a random key, in order to create a unique link&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">secret_key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">secret_key</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">secret_key</span>
    <span class="k">return</span> <span class="n">URLSafeSerializer</span><span class="p">(</span><span class="n">secret_key</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="sendVerificationEmail"><a class="viewcode-back" href="../../api.html#justHealthServer.api.sendVerificationEmail">[docs]</a><span class="k">def</span> <span class="nf">sendVerificationEmail</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sends email to the user after registration asking for account verification&quot;&quot;&quot;</span>
    <span class="c"># Generate Verification Link</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">getSerializer</span><span class="p">()</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="n">verifyLink</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s">&#39;verifyUser&#39;</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c"># Login to mail server</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP_SSL</span><span class="p">(</span><span class="s">&#39;smtp.zoho.com&#39;</span><span class="p">,</span> <span class="mi">465</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s">&#39;justhealth@richlogan.co.uk&#39;</span><span class="p">,</span> <span class="s">&quot;justhealth&quot;</span><span class="p">)</span>
    <span class="c"># Build message</span>
    <span class="n">sender</span> <span class="o">=</span> <span class="s">&quot;&#39;JustHealth&#39; &lt;justhealth@richlogan.co.uk&gt;&quot;</span>
    <span class="n">recipient</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">email</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s">&quot;JustHealth Verification&quot;</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Thanks for registering! Please verify your account here: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">verifyLink</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="s">&quot;From: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s">To: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s">Subject: </span><span class="si">%s</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">recipient</span><span class="p">,</span> <span class="n">subject</span><span class="p">)</span>
    <span class="c"># Send</span>
    <span class="n">server</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">recipient</span><span class="p">,</span> <span class="n">m</span><span class="o">+</span><span class="n">message</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="getUserFromEmail"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getUserFromEmail">[docs]</a><span class="k">def</span> <span class="nf">getUserFromEmail</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get username from the database for a valid email address&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">username</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">username</span><span class="o">.</span><span class="n">username</span>
    <span class="k">except</span> <span class="n">Client</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
      <span class="k">return</span> <span class="s">&quot;False&quot;</span>
</div>
<div class="viewcode-block" id="sendForgotPasswordEmail"><a class="viewcode-back" href="../../api.html#justHealthServer.api.sendForgotPasswordEmail">[docs]</a><span class="k">def</span> <span class="nf">sendForgotPasswordEmail</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sends email to the user on completion of reset password form&quot;&quot;&quot;</span>
    <span class="c">#Generate reset password Link</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">getSerializer</span><span class="p">()</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="n">resetLink</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s">&#39;loadPasswordReset&#39;</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c"># Login to mail server</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP_SSL</span><span class="p">(</span><span class="s">&#39;smtp.zoho.com&#39;</span><span class="p">,</span> <span class="mi">465</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s">&#39;justhealth@richlogan.co.uk&#39;</span><span class="p">,</span> <span class="s">&quot;justhealth&quot;</span><span class="p">)</span>
    <span class="c"># Build message</span>
    <span class="n">sender</span> <span class="o">=</span> <span class="s">&quot;&#39;JustHealth&#39; &lt;justhealth@richlogan.co.uk&gt;&quot;</span>
    <span class="n">recipient</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">email</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s">&quot;JustHealth: Forgot Password&quot;</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Please reset your JustHealth account password here:</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">resetLink</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; </span><span class="se">\n</span><span class="s"> </span><span class="se">\n</span><span class="s">(Please do not use Internet Explorer to open this link)&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="s">&quot;From: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s">To: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s">Subject: </span><span class="si">%s</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">recipient</span><span class="p">,</span> <span class="n">subject</span><span class="p">)</span>
    <span class="c"># Send</span>
    <span class="n">server</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">recipient</span><span class="p">,</span> <span class="n">m</span><span class="o">+</span><span class="n">message</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="sendUnlockEmail"><a class="viewcode-back" href="../../api.html#justHealthServer.api.sendUnlockEmail">[docs]</a><span class="k">def</span> <span class="nf">sendUnlockEmail</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sends email to a user when account is locked due to too many unsuccessful attempts&quot;&quot;&quot;</span>
    <span class="c"># Login to mail server</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">getSerializer</span><span class="p">()</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="n">resetLink</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s">&#39;loadPasswordReset&#39;</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c"># Login to mail server</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP_SSL</span><span class="p">(</span><span class="s">&#39;smtp.zoho.com&#39;</span><span class="p">,</span> <span class="mi">465</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s">&#39;justhealth@richlogan.co.uk&#39;</span><span class="p">,</span> <span class="s">&quot;justhealth&quot;</span><span class="p">)</span>
    <span class="c"># Build message</span>
    <span class="n">sender</span> <span class="o">=</span> <span class="s">&quot;&#39;JustHealth&#39; &lt;justhealth@richlogan.co.uk&gt;&quot;</span>
    <span class="n">recipient</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">email</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s">&quot;JustHealth: Account Locked&quot;</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Due to too many failed login attempts, your JustHealth account has been locked and you will be required to reset your password. Please reset your JustHealth account password here: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">resetLink</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;. If it was not you who locked the account please notify JustHealth immediately by replying to this email. Thank you. &quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="s">&quot;From: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s">To: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s">Subject: </span><span class="si">%s</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">recipient</span><span class="p">,</span> <span class="n">subject</span><span class="p">)</span>
    <span class="c"># Send</span>
    <span class="n">server</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">recipient</span><span class="p">,</span> <span class="n">m</span><span class="o">+</span><span class="n">message</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="sendPasswordResetEmail"><a class="viewcode-back" href="../../api.html#justHealthServer.api.sendPasswordResetEmail">[docs]</a><span class="k">def</span> <span class="nf">sendPasswordResetEmail</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sends user email confirming password reset&quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">getSerializer</span><span class="p">()</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="n">verifyLink</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s">&#39;passwordReset&#39;</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c">#Login to mail server</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP_SSL</span><span class="p">(</span><span class="s">&#39;smtp.zoho.com&#39;</span><span class="p">,</span> <span class="mi">465</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s">&#39;justhealth@richlogan.co.uk&#39;</span><span class="p">,</span> <span class="s">&quot;justhealth&quot;</span><span class="p">)</span>
    <span class="c"># Build Message</span>
    <span class="n">sender</span> <span class="o">=</span> <span class="s">&quot;&#39;JustHealth&#39; &lt;justhealth@richlogan.co.uk&gt;&quot;</span>
    <span class="n">recipient</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">email</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s">&quot;JustHealth Password Reset Verification&quot;</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Your password has been reset. Please verify this here: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">verifyLink</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="s">&quot;From: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s">To: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s">Subject: </span><span class="si">%s</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">recipient</span><span class="p">,</span> <span class="n">subject</span><span class="p">)</span>
    <span class="c"># Send</span>
    <span class="n">server</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">recipient</span><span class="p">,</span> <span class="n">m</span><span class="o">+</span><span class="n">message</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="sendContactUs"><a class="viewcode-back" href="../../api.html#justHealthServer.api.sendContactUs">[docs]</a><span class="k">def</span> <span class="nf">sendContactUs</span><span class="p">(</span><span class="n">details</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sends email to justhealth when a user has a question&quot;&quot;&quot;</span>
    <span class="c">#Login to mail server</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP_SSL</span><span class="p">(</span><span class="s">&#39;smtp.zoho.com&#39;</span><span class="p">,</span> <span class="mi">465</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s">&#39;justhealth@richlogan.co.uk&#39;</span><span class="p">,</span> <span class="s">&quot;justhealth&quot;</span><span class="p">)</span>
    <span class="c"># Build Message</span>
    <span class="n">sender</span> <span class="o">=</span> <span class="s">&quot;&#39;JustHealth User Question&#39; &lt;justhealth@richlogan.co.uk&gt;&quot;</span>
    <span class="n">cc</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">email</span>
    <span class="n">recipient</span> <span class="o">=</span> <span class="s">&#39;justhealth@richlogan.co.uk&#39;</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s">&quot;JustHealth User Question&quot;</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="s">&quot;From: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s">To: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s">Subject: </span><span class="si">%s</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">recipient</span><span class="p">,</span> <span class="n">subject</span><span class="p">)</span>
    <span class="c"># Send</span>
    <span class="n">server</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">recipient</span><span class="p">,</span> <span class="n">m</span><span class="o">+</span><span class="n">message</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

<span class="c">####</span>
<span class="c"># Search Patient Carer</span>
<span class="c">####</span></div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/searchPatientCarer&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">searchPatientCarer</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Searches database for a user that can be connected to. POST [username, searchterm]&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">searchPatientCarer</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;searchterm&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">searchPatientCarer</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">searchterm</span><span class="p">):</span>
    <span class="c">#get username, firstname and surname of current user</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">searchterm</span> <span class="o">=</span> <span class="s">&quot;%&quot;</span> <span class="o">+</span> <span class="n">searchterm</span> <span class="o">+</span> <span class="s">&quot;%&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">patient</span> <span class="o">=</span> <span class="n">Patient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">Carer</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">Carer</span><span class="o">.</span><span class="n">username</span> <span class="o">**</span> <span class="n">searchterm</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">Carer</span><span class="o">.</span><span class="n">firstname</span> <span class="o">**</span> <span class="n">searchterm</span><span class="p">)</span> <span class="o">|</span><span class="p">(</span><span class="n">Carer</span><span class="o">.</span><span class="n">surname</span> <span class="o">**</span> <span class="n">searchterm</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">Patient</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">Patient</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">Patient</span><span class="o">.</span><span class="n">username</span> <span class="o">**</span> <span class="n">searchterm</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">Patient</span><span class="o">.</span><span class="n">firstname</span> <span class="o">**</span> <span class="n">searchterm</span><span class="p">)</span> <span class="o">|</span><span class="p">(</span><span class="n">Patient</span><span class="o">.</span><span class="n">surname</span> <span class="o">**</span> <span class="n">searchterm</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;No users found&quot;</span>

    <span class="n">jsonResult</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="c"># Check if result is already a connection</span>
        <span class="n">currentConnections</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getConnections</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">currentConnections</span><span class="p">[</span><span class="s">&#39;outgoing&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">connection</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]:</span>
                <span class="n">result</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Already Requested&quot;</span>
        
        <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">currentConnections</span><span class="p">[</span><span class="s">&#39;incoming&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">connection</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]:</span>
                <span class="n">result</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Request Waiting&quot;</span>

        <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">currentConnections</span><span class="p">[</span><span class="s">&#39;completed&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">connection</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]:</span>
                <span class="n">result</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Already Connected&quot;</span>

        <span class="n">jsonResult</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">jsonResult</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">getConnectionStatus</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="n">currentConnections</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getConnections</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">currentConnections</span><span class="p">[</span><span class="s">&#39;outgoing&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">connection</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;Already Requested&quot;</span>
    
    <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">currentConnections</span><span class="p">[</span><span class="s">&#39;incoming&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">connection</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;Request Waiting&quot;</span>

    <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">currentConnections</span><span class="p">[</span><span class="s">&#39;completed&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">connection</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;Already Connected&quot;</span>
    <span class="k">return</span> <span class="s">&quot;None&quot;</span>

<span class="c">####</span>
<span class="c"># Client/Client relationships</span>
<span class="c">####</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/createConnection&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">createConnection</span><span class="p">():</span>
    <span class="c">#although this is for a patient and a carer we only need to check the patient </span>
    <span class="c"># because they aren&#39;t yet connected</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">createConnection</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>

<div class="viewcode-block" id="createConnection"><a class="viewcode-back" href="../../api.html#justHealthServer.api.createConnection">[docs]</a><span class="k">def</span> <span class="nf">createConnection</span><span class="p">(</span><span class="n">details</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates an initial connection between two users. POST [username, target]&quot;&quot;&quot;</span>
    <span class="c"># Get users</span>
    <span class="n">currentUser</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
    <span class="n">targetUser</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">]</span>

    <span class="c"># Test Users</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">doesUserExist</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">currentUser</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">Client</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;User does not exist&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">doesTargetExist</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">targetUser</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">Client</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;Target does not exist&quot;</span>

    <span class="c"># Get user types</span>
    <span class="n">currentUser_type</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">currentUser</span><span class="p">))[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span>
    <span class="n">targetUser_type</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">targetUser</span><span class="p">))[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span>


    <span class="c"># Need to check if connection already exists, requested, or if they have requested for you.</span>
    <span class="n">check</span> <span class="o">=</span> <span class="n">getConnectionStatus</span><span class="p">(</span><span class="n">currentUser</span><span class="p">,</span> <span class="n">targetUser</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">check</span> <span class="o">!=</span> <span class="s">&quot;None&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">check</span>

    <span class="c"># Generate 4 digit code</span>
    <span class="n">x</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c"># Insert into Connection table</span>
    <span class="n">newConnection</span> <span class="o">=</span> <span class="n">Relationship</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span>
        <span class="n">requestor</span> <span class="o">=</span> <span class="n">currentUser</span><span class="p">,</span>
        <span class="n">requestortype</span> <span class="o">=</span> <span class="n">currentUser_type</span><span class="p">,</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">targetUser</span><span class="p">,</span>
        <span class="n">targettype</span> <span class="o">=</span> <span class="n">targetUser_type</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
        <span class="n">newConnection</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">createNotificationRecord</span><span class="p">(</span><span class="n">targetUser</span><span class="p">,</span> <span class="s">&quot;Connection Request&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">newConnection</span><span class="o">.</span><span class="n">connectionid</span><span class="p">))</span>
        <span class="k">return</span> <span class="s">&quot;Give the code &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&#39; to &quot;</span> <span class="o">+</span> <span class="n">targetUser</span> <span class="o">+</span> <span class="s">&quot; so they can accept your request&quot;</span>
    <span class="k">return</span> <span class="s">&quot;False&quot;</span>


</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/completeConnection&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">completeConnection</span><span class="p">():</span>
    <span class="c">#The patient and carer are yet to be connected so therefore we only need to check</span>
    <span class="c"># the account of the user that is making the request</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">completeConnection</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>

<div class="viewcode-block" id="completeConnection"><a class="viewcode-back" href="../../api.html#justHealthServer.api.completeConnection">[docs]</a><span class="k">def</span> <span class="nf">completeConnection</span><span class="p">(</span><span class="n">details</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Verify a code on input to allow the completion of an attempted connection. POST[ username, requestor, codeattempt] &quot;&quot;&quot;</span>
    <span class="c">#Take attempted code, match with a entry where they are target</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
    <span class="n">requestor</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;requestor&#39;</span><span class="p">]</span>
    <span class="n">attemptedCode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;codeattempt&#39;</span><span class="p">])</span>

    <span class="c"># get record</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">Relationship</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">Relationship</span><span class="o">.</span><span class="n">requestor</span> <span class="o">==</span> <span class="n">requestor</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Relationship</span><span class="o">.</span><span class="n">target</span> <span class="o">==</span> <span class="n">target</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">attemptedCode</span><span class="p">:</span>
        <span class="c"># Correct attempt, establish relationship in correct table</span>
        <span class="c"># TODO place into relationship table</span>
        <span class="n">requestor_accountType</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">requestor</span><span class="p">))[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span>
        <span class="n">target_accountType</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">target</span><span class="p">))[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">requestor_accountType</span> <span class="o">==</span> <span class="s">&quot;Patient&quot;</span> <span class="ow">and</span> <span class="n">target_accountType</span> <span class="o">==</span> <span class="s">&quot;Carer&quot;</span><span class="p">:</span>
            <span class="n">newRelationship</span> <span class="o">=</span> <span class="n">Patientcarer</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">patient</span> <span class="o">=</span> <span class="n">requestor</span><span class="p">,</span>
                <span class="n">carer</span> <span class="o">=</span> <span class="n">target</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                <span class="n">newRelationship</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">requestor_accountType</span> <span class="o">==</span> <span class="s">&quot;Carer&quot;</span> <span class="ow">and</span> <span class="n">target_accountType</span> <span class="o">==</span> <span class="s">&quot;Patient&quot;</span><span class="p">:</span>
            <span class="n">newRelationship</span> <span class="o">=</span> <span class="n">Patientcarer</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">patient</span> <span class="o">=</span> <span class="n">target</span><span class="p">,</span>
                <span class="n">carer</span> <span class="o">=</span> <span class="n">requestor</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                <span class="n">newRelationship</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

        <span class="c"># Delete this Relationship instance</span>
        <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
            
            <span class="c">#creates the notification to inform the original requestor</span>
            <span class="n">createNotificationRecord</span><span class="p">(</span><span class="n">requestor</span><span class="p">,</span> <span class="s">&quot;New Connection&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="s">&quot;Connection to &quot;</span> <span class="o">+</span> <span class="n">requestor</span> <span class="o">+</span> <span class="s">&quot; completed&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;Incorrect code&quot;</span>
    <span class="k">return</span> <span class="bp">None</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/deleteConnection&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">deleteConnection</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Deletes connection between a patient and carer POST[user, connection]&quot;&quot;&quot;</span>
    <span class="c">#We only need to check the user and not the carer&#39;s authenticity</span>
    <span class="c"># as no information about the patient is being returned.</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">deleteConnection</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">deleteConnection</span><span class="p">(</span><span class="n">details</span><span class="p">):</span>
    <span class="n">userType</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">]))[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span>
    <span class="n">connectionType</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;connection&#39;</span><span class="p">]))[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">Patientcarer</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">Patientcarer</span><span class="o">.</span><span class="n">patient</span> <span class="o">==</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Patientcarer</span><span class="o">.</span><span class="n">carer</span> <span class="o">==</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;connection&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
            <span class="k">return</span> <span class="s">&quot;True&quot;</span>
    <span class="k">except</span> <span class="n">Patientcarer</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">Patientcarer</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">Patientcarer</span><span class="o">.</span><span class="n">patient</span> <span class="o">==</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;connection&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Patientcarer</span><span class="o">.</span><span class="n">carer</span> <span class="o">==</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
                <span class="k">return</span> <span class="s">&quot;True&quot;</span>
        
        <span class="k">except</span> <span class="n">Patientcarer</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;False&quot;</span>
            
        
    <span class="k">return</span> <span class="s">&quot;False&quot;</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/cancelConnection&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">cancelRequest</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cancelRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>

<div class="viewcode-block" id="cancelRequest"><a class="viewcode-back" href="../../api.html#justHealthServer.api.cancelRequest">[docs]</a><span class="k">def</span> <span class="nf">cancelRequest</span><span class="p">(</span><span class="n">details</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Cancels the user request to connect before completion&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">Relationship</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">Relationship</span><span class="o">.</span><span class="n">requestor</span> <span class="o">==</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Relationship</span><span class="o">.</span><span class="n">target</span> <span class="o">==</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;connection&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
            <span class="k">return</span> <span class="s">&quot;True&quot;</span>
    <span class="k">except</span> <span class="n">Relationship</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">Relationship</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">Relationship</span><span class="o">.</span><span class="n">target</span> <span class="o">==</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">Relationship</span><span class="o">.</span><span class="n">requestor</span> <span class="o">==</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;connection&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
                <span class="k">return</span> <span class="s">&quot;True&quot;</span>
        <span class="k">except</span> <span class="n">Relationship</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;False&quot;</span>
    <span class="k">return</span> <span class="s">&quot;False&quot;</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/getConnections&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">getConnections</span><span class="p">():</span>
    <span class="c">#Any authenticated user is entitled to retrieve their connections</span>
    <span class="c"># we do not need to check the persons that they are connected too.</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">getConnections</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="getConnections"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getConnections">[docs]</a><span class="k">def</span> <span class="nf">getConnections</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the valid connections between two users&quot;&quot;&quot;</span>
    <span class="n">accountType</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">username</span><span class="p">))[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span><span class="o">==</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="n">outgoingConnections</span> <span class="o">=</span> <span class="n">Relationship</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Relationship</span><span class="o">.</span><span class="n">requestor</span> <span class="o">==</span> <span class="n">user</span><span class="p">)</span>
    <span class="n">incomingConnections</span> <span class="o">=</span> <span class="n">Relationship</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Relationship</span><span class="o">.</span><span class="n">target</span> <span class="o">==</span> <span class="n">user</span><span class="p">)</span>

    <span class="n">completedConnections</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">accountType</span> <span class="o">==</span> <span class="s">&quot;Patient&quot;</span><span class="p">:</span>
        <span class="n">completedConnections</span> <span class="o">=</span> <span class="n">Patientcarer</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Patientcarer</span><span class="o">.</span><span class="n">patient</span> <span class="o">==</span> <span class="n">user</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">accountType</span> <span class="o">==</span> <span class="s">&quot;Carer&quot;</span><span class="p">:</span>
        <span class="n">completedConnections</span> <span class="o">=</span> <span class="n">Patientcarer</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Patientcarer</span><span class="o">.</span><span class="n">carer</span> <span class="o">==</span> <span class="n">user</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">completedConnections</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#username, firstname, surname, accountype</span>
    <span class="n">outgoingConnectionsDetails</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">outgoingConnections</span><span class="p">:</span>
        <span class="n">person</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">details</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">username</span><span class="p">))</span>
        <span class="n">person</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
        <span class="n">person</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">]</span>
        <span class="n">person</span><span class="p">[</span><span class="s">&#39;surname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;surname&#39;</span><span class="p">]</span>
        <span class="n">person</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span>
        <span class="n">person</span><span class="p">[</span><span class="s">&#39;profilepicture&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;profilepicture&#39;</span><span class="p">]</span>
        <span class="n">person</span><span class="p">[</span><span class="s">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
        <span class="n">outgoingConnectionsDetails</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
    <span class="n">outgoingFinal</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">outgoingConnectionsDetails</span><span class="p">)</span>

    <span class="n">incomingConnectionsDetails</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">incomingConnections</span><span class="p">:</span>
        <span class="n">person</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">details</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">requestor</span><span class="o">.</span><span class="n">username</span><span class="p">))</span>
        <span class="n">person</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
        <span class="n">person</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">]</span>
        <span class="n">person</span><span class="p">[</span><span class="s">&#39;surname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;surname&#39;</span><span class="p">]</span>
        <span class="n">person</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span>
        <span class="n">person</span><span class="p">[</span><span class="s">&#39;profilepicture&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;profilepicture&#39;</span><span class="p">]</span>
        <span class="n">person</span><span class="p">[</span><span class="s">&#39;connectionid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">connectionid</span><span class="p">)</span>
        <span class="n">incomingConnectionsDetails</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
    <span class="n">incomingFinal</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">incomingConnectionsDetails</span><span class="p">)</span>

    <span class="n">completedConnectionsDetails</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">completedConnections</span><span class="p">:</span>
        <span class="n">person</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">accountType</span> <span class="o">==</span> <span class="s">&quot;Patient&quot;</span><span class="p">:</span>
            <span class="n">details</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">carer</span><span class="o">.</span><span class="n">username</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">accountType</span> <span class="o">==</span> <span class="s">&quot;Carer&quot;</span><span class="p">:</span>
            <span class="n">details</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">username</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">details</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">person</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
        <span class="n">person</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">]</span>
        <span class="n">person</span><span class="p">[</span><span class="s">&#39;surname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;surname&#39;</span><span class="p">]</span>
        <span class="n">person</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span> <span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span>
        <span class="n">person</span><span class="p">[</span><span class="s">&#39;telephonenumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span> <span class="p">[</span><span class="s">&#39;telephonenumber&#39;</span><span class="p">]</span>
        <span class="n">person</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span>
        <span class="n">person</span><span class="p">[</span><span class="s">&#39;profilepicture&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;profilepicture&#39;</span><span class="p">]</span>
        <span class="n">completedConnectionsDetails</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
    <span class="n">completedFinal</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">completedConnectionsDetails</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">result</span><span class="p">[</span><span class="s">&#39;outgoing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outgoingFinal</span>
    <span class="n">result</span><span class="p">[</span><span class="s">&#39;incoming&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">incomingFinal</span>
    <span class="n">result</span><span class="p">[</span><span class="s">&#39;completed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">completedFinal</span>

    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="c">#receives the request from android allows a patient to add an appointment</span></div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/addPatientAppointment&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">addPatientAppointment</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;creator&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">addPatientAppointment</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>

<span class="c">#allows a all self appointments to be added </span>
<span class="c">#Note originally there was going to be a seperate method for carers, however this is no longer the case. </span>
<span class="k">def</span> <span class="nf">addPatientAppointment</span><span class="p">(</span><span class="n">details</span><span class="p">):</span>
<span class="c"># Build insert user query</span>
  <span class="k">if</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;private&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;False&quot;</span><span class="p">:</span>
    <span class="n">isPrivate</span> <span class="o">=</span> <span class="bp">False</span>
  <span class="k">else</span><span class="p">:</span> 
    <span class="n">isPrivate</span> <span class="o">=</span> <span class="bp">True</span>

  <span class="n">appointmentInsert</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
    <span class="n">creator</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;creator&#39;</span><span class="p">],</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span>
    <span class="n">apptype</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;apptype&#39;</span><span class="p">],</span>
    <span class="n">addressnamenumber</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;addressnamenumber&#39;</span><span class="p">],</span>
    <span class="n">postcode</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;postcode&#39;</span><span class="p">],</span>
    <span class="n">startdate</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">],</span>
    <span class="n">starttime</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">],</span>
    <span class="n">enddate</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">],</span>
    <span class="n">endtime</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;endtime&#39;</span><span class="p">],</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">],</span>
    <span class="n">private</span> <span class="o">=</span> <span class="n">isPrivate</span>
  <span class="p">)</span>

  <span class="n">appId</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">appointmentInsert</span><span class="o">.</span><span class="n">execute</span><span class="p">())</span>
  
  <span class="k">return</span> <span class="n">appId</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/addInviteeAppointment&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">addInviteeAppointment</span><span class="p">():</span>
    <span class="c">#The creator will always be a carer, therefore we have to check that they are connected</span>
    <span class="c"># to the patient that they are making the appointment with</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;creator&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">addInviteeAppointment</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">addInviteeAppointment</span><span class="p">(</span><span class="n">details</span><span class="p">):</span>
  <span class="c">#Build insert user query</span>
  <span class="n">appointmentInsert</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
    <span class="n">creator</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;creator&#39;</span><span class="p">],</span>
    <span class="n">invitee</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span>
    <span class="n">apptype</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;apptype&#39;</span><span class="p">],</span>
    <span class="n">addressnamenumber</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;addressnamenumber&#39;</span><span class="p">],</span>
    <span class="n">postcode</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;postcode&#39;</span><span class="p">],</span>
    <span class="n">startdate</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">],</span>
    <span class="n">starttime</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">],</span>
    <span class="n">enddate</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">],</span>
    <span class="n">endtime</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;endtime&#39;</span><span class="p">],</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">],</span>
    <span class="n">private</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="n">accepted</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="p">)</span>

  <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
    <span class="n">appId</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">appointmentInsert</span><span class="o">.</span><span class="n">execute</span><span class="p">())</span>
    <span class="n">createNotificationRecord</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="s">&quot;Appointment Invite&quot;</span><span class="p">,</span> <span class="n">appId</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">appId</span>
  <span class="k">return</span><span class="s">&quot;False&quot;</span>

<span class="c">#receives the request from android to allow a user to view their upcoming appointments</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/getAllAppointments&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">getAllAppointments</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;loggedInUser&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;targetUser&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;loggedInUser&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">getAllAppointments</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;loggedInUser&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;targetUser&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;loggedInUser&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;targetUser&#39;</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">getAllAppointments</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;loggedInUser&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;targetUser&#39;</span><span class="p">])</span>

<span class="c">#gets the appointments from the database</span>
<span class="k">def</span> <span class="nf">getAllAppointments</span><span class="p">(</span><span class="n">loggedInUser</span><span class="p">,</span> <span class="n">targetUser</span><span class="p">):</span>
  <span class="c">#get user account type </span>
  <span class="n">currentUser_type</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">loggedInUser</span><span class="p">))[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span>

  <span class="k">if</span> <span class="n">currentUser_type</span> <span class="o">==</span> <span class="s">&quot;Carer&quot;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">loggedInUser</span> <span class="o">==</span> <span class="n">targetUser</span><span class="p">:</span>
       <span class="n">appointments</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">Appointments</span><span class="o">.</span><span class="n">creator</span> <span class="o">==</span> <span class="n">targetUser</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">invitee</span> <span class="o">==</span> <span class="n">targetUser</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">startdate</span><span class="o">.</span><span class="n">asc</span><span class="p">(),</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">appointments</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">Appointments</span><span class="o">.</span><span class="n">creator</span> <span class="o">==</span> <span class="n">targetUser</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">private</span> <span class="o">==</span> <span class="bp">False</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="n">Appointments</span><span class="o">.</span><span class="n">invitee</span> <span class="o">==</span> <span class="n">targetUser</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">private</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">startdate</span><span class="o">.</span><span class="n">asc</span><span class="p">(),</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span>
  <span class="k">elif</span> <span class="n">currentUser_type</span> <span class="o">==</span> <span class="s">&quot;Patient&quot;</span><span class="p">:</span>
    <span class="n">appointments</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">Appointments</span><span class="o">.</span><span class="n">creator</span> <span class="o">==</span> <span class="n">targetUser</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">invitee</span> <span class="o">==</span> <span class="n">targetUser</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">startdate</span><span class="o">.</span><span class="n">asc</span><span class="p">(),</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span>
  
  <span class="n">appointments</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

  <span class="n">currentDateTime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

  <span class="n">allAppointments</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="n">appointments</span><span class="p">:</span>
    <span class="n">appointment</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;appid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">appid</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;creator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">creator</span><span class="o">.</span><span class="n">username</span>
    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">invitee</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;invitee&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;invitee&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">invitee</span><span class="o">.</span><span class="n">username</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">name</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;apptype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">apptype</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;addressnamenumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">addressnamenumber</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;postcode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">postcode</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">startdate</span><span class="p">)</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">starttime</span><span class="p">)</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">enddate</span><span class="p">)</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;endtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">endtime</span><span class="p">)</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">description</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;private&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">private</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;androideventid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">androideventid</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;accepted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">accepted</span>
    
    <span class="n">dateTime</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">enddate</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">endtime</span><span class="p">)</span>
    <span class="n">dateTime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">dateTime</span><span class="p">,</span> <span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dateTime</span> <span class="o">&gt;=</span> <span class="n">currentDateTime</span><span class="p">):</span>
      <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;upcoming&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;upcoming&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">allAppointments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">appointment</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">allAppointments</span><span class="p">)</span>

<span class="c">#deletes an appointment</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/deleteAppointment&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">deleteAppointment</span><span class="p">():</span>
    <span class="c">#if verifyContentRequest(request.form[&#39;username&#39;], &quot;&quot;):</span>
    <span class="k">return</span> <span class="n">deleteAppointment</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;appid&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">deleteAppointment</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">appid</span><span class="p">):</span>
  <span class="n">isCreator</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">appid</span> <span class="o">==</span> <span class="n">appid</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

  <span class="k">if</span> <span class="n">isCreator</span><span class="o">.</span><span class="n">creator</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">user</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">isCreator</span><span class="o">.</span><span class="n">invitee</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">invitee</span> <span class="o">=</span> <span class="n">isCreator</span><span class="o">.</span><span class="n">invitee</span><span class="o">.</span><span class="n">username</span>
            <span class="n">createNotificationRecord</span><span class="p">(</span><span class="n">invitee</span><span class="p">,</span> <span class="s">&quot;Appointment Cancelled&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">isCreator</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>

    <span class="k">return</span> <span class="s">&quot;Appointment Deleted&quot;</span>

<span class="c">#gets the appointment that is to be updated</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/getUpdateAppointment&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">getUpdateAppointment</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">updateAppointment</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;appid&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">getUpdateAppointment</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">appid</span><span class="p">):</span>
  <span class="n">isCreator</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">appid</span> <span class="o">==</span> <span class="n">appid</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

  <span class="k">if</span> <span class="n">isCreator</span><span class="o">.</span><span class="n">creator</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">user</span><span class="p">:</span>
    <span class="n">jsonResult</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">appointment</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;appid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isCreator</span><span class="o">.</span><span class="n">appid</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;creator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isCreator</span><span class="o">.</span><span class="n">creator</span><span class="o">.</span><span class="n">username</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isCreator</span><span class="o">.</span><span class="n">name</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;apptype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">isCreator</span><span class="o">.</span><span class="n">apptype</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;addressnamenumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isCreator</span><span class="o">.</span><span class="n">addressnamenumber</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;postcode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isCreator</span><span class="o">.</span><span class="n">postcode</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">isCreator</span><span class="o">.</span><span class="n">startdate</span><span class="p">)</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">isCreator</span><span class="o">.</span><span class="n">starttime</span><span class="p">)</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">isCreator</span><span class="o">.</span><span class="n">enddate</span><span class="p">)</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;endtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">isCreator</span><span class="o">.</span><span class="n">endtime</span><span class="p">)</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isCreator</span><span class="o">.</span><span class="n">description</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;private&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isCreator</span><span class="o">.</span><span class="n">private</span>

    <span class="n">jsonResult</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">appointment</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">jsonResult</span><span class="p">)</span>


<span class="c">#update an appointment</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/updateAppointment&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">updateAppointment</span><span class="p">():</span>
    <span class="c">#username isn&#39;t sent with the request, so here we need to get the creator of the appointment from the database.</span>
    <span class="n">appointment</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">appid</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;appid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">appointment</span><span class="o">.</span><span class="n">creator</span><span class="o">.</span><span class="n">username</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">updateAppointment</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;appid&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;apptype&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;addressnamenumber&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;postcode&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;endtime&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;other&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;private&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">updateAppointment</span><span class="p">(</span><span class="n">appid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">apptype</span><span class="p">,</span> <span class="n">addressnamenumber</span><span class="p">,</span> <span class="n">postcode</span><span class="p">,</span> <span class="n">startDate</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">endDate</span><span class="p">,</span> <span class="n">endTime</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">private</span><span class="p">):</span>
  <span class="n">checkInvitee</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">appid</span> <span class="o">==</span> <span class="n">appid</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
  <span class="c">#This stops the appointment from being marked as private when it is an invitee appointment</span>
  <span class="k">if</span> <span class="n">checkInvitee</span><span class="o">.</span><span class="n">invitee</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">isPrivate</span> <span class="o">=</span> <span class="bp">False</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">private</span> <span class="o">==</span> <span class="s">&quot;False&quot;</span><span class="p">:</span>
      <span class="n">isPrivate</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span> 
      <span class="n">isPrivate</span> <span class="o">=</span> <span class="bp">True</span>

  <span class="n">updateAppointment</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span>
    <span class="n">apptype</span> <span class="o">=</span> <span class="n">apptype</span><span class="p">,</span>
    <span class="n">addressnamenumber</span> <span class="o">=</span> <span class="n">addressnamenumber</span><span class="p">,</span>
    <span class="n">postcode</span> <span class="o">=</span> <span class="n">postcode</span><span class="p">,</span>
    <span class="n">startdate</span> <span class="o">=</span> <span class="n">startDate</span><span class="p">,</span>
    <span class="n">starttime</span> <span class="o">=</span> <span class="n">startTime</span><span class="p">,</span>
    <span class="n">enddate</span> <span class="o">=</span> <span class="n">endDate</span><span class="p">,</span>
    <span class="n">endtime</span> <span class="o">=</span> <span class="n">endTime</span><span class="p">,</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="p">,</span>
    <span class="n">private</span> <span class="o">=</span> <span class="n">isPrivate</span><span class="p">,</span>
    <span class="n">accepted</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">appid</span> <span class="o">==</span> <span class="n">appid</span><span class="p">)</span>

  <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
    <span class="n">updateAppointment</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="c">#check if the appointment has an invitee</span>
    <span class="n">appointment</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">appid</span> <span class="o">==</span> <span class="n">appid</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">appointment</span><span class="o">.</span><span class="n">invitee</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">createNotificationRecord</span><span class="p">(</span><span class="n">appointment</span><span class="o">.</span><span class="n">invitee</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&quot;Appointment Updated&quot;</span><span class="p">,</span> <span class="n">appid</span><span class="p">)</span>


  <span class="k">return</span> <span class="s">&quot;Appointment Updated&quot;</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/getAppointment&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">getAppointment</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">getAppointment</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;appid&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">getAppointment</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">appid</span><span class="p">):</span>
  <span class="n">isRelated</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">appid</span> <span class="o">==</span> <span class="n">appid</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">isRelated</span><span class="o">.</span><span class="n">creator</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">user</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">isRelated</span><span class="o">.</span><span class="n">invitee</span><span class="o">.</span><span class="n">username</span><span class="p">):</span>

    <span class="n">appointment</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;appid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isRelated</span><span class="o">.</span><span class="n">appid</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;creator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isRelated</span><span class="o">.</span><span class="n">creator</span><span class="o">.</span><span class="n">username</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isRelated</span><span class="o">.</span><span class="n">name</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;apptype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">isRelated</span><span class="o">.</span><span class="n">apptype</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;addressnamenumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isRelated</span><span class="o">.</span><span class="n">addressnamenumber</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;postcode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isRelated</span><span class="o">.</span><span class="n">postcode</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">isRelated</span><span class="o">.</span><span class="n">startdate</span><span class="p">)</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">isRelated</span><span class="o">.</span><span class="n">starttime</span><span class="p">)</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">isRelated</span><span class="o">.</span><span class="n">enddate</span><span class="p">)</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;endtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">isRelated</span><span class="o">.</span><span class="n">endtime</span><span class="p">)</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isRelated</span><span class="o">.</span><span class="n">description</span>
    <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;private&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isRelated</span><span class="o">.</span><span class="n">private</span>

    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">appointment</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/acceptDeclineAppointment&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">acceptDeclineAppointment</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">acceptDeclineAppointment</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;action&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;appid&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">acceptDeclineAppointment</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">appointmentId</span><span class="p">):</span> 
    <span class="n">appointment</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">appid</span> <span class="o">==</span> <span class="n">appointmentId</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">==</span> <span class="n">appointment</span><span class="o">.</span><span class="n">invitee</span><span class="o">.</span><span class="n">username</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s">&quot;Accept&quot;</span><span class="p">:</span> 
            <span class="n">accepted</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">notificationType</span> <span class="o">=</span> <span class="s">&quot;Appointment Accepted&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s">&quot;You have accepted this appointment.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">accepted</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">notificationType</span> <span class="o">=</span> <span class="s">&quot;Appointment Declined&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s">&quot;You have declined this appointment.&quot;</span>
        <span class="n">submitAction</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">accepted</span> <span class="o">=</span> <span class="n">accepted</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">appid</span> <span class="o">==</span> <span class="n">appointmentId</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
            <span class="n">submitAction</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="n">createNotificationRecord</span><span class="p">(</span><span class="n">appointment</span><span class="o">.</span><span class="n">creator</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">notificationType</span><span class="p">,</span> <span class="n">appointmentId</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="k">return</span> <span class="s">&quot;Failed&quot;</span>
    <span class="k">return</span> <span class="s">&quot;You have not been invited to this appointment.&quot;</span>

<span class="k">def</span> <span class="nf">addMedication</span><span class="p">(</span><span class="n">medicationName</span><span class="p">):</span>
    <span class="n">insertMedication</span> <span class="o">=</span> <span class="n">Medication</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">medicationName</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">insertMedication</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="k">return</span> <span class="s">&quot;Added &quot;</span> <span class="o">+</span> <span class="n">medicationName</span>
        <span class="k">except</span> <span class="n">IntegrityError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">medicationName</span> <span class="o">+</span> <span class="s">&quot; already exists&quot;</span>
    <span class="k">return</span> <span class="s">&quot;False&quot;</span>

<span class="k">def</span> <span class="nf">deleteMedication</span><span class="p">(</span><span class="n">medicationName</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">Medication</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Medication</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">medicationName</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&quot;Deleted &quot;</span> <span class="o">+</span> <span class="n">medicationName</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">medicationName</span> <span class="o">+</span> <span class="s">&quot;not found&quot;</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/getMedications&#39;</span><span class="p">)</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">getMedications</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">getMedications</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">getMedications</span><span class="p">():</span>
    <span class="n">medicationList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">Medication</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">medicationList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">medicationList</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/addPrescription&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">addPrescription</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">getUsernameFromHeader</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">addPrescription</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">addPrescription</span><span class="p">(</span><span class="n">details</span><span class="p">):</span>
    <span class="n">Monday</span> <span class="o">=</span> <span class="bp">False</span><span class="p">;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Monday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Monday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Monday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Monday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;on&quot;</span><span class="p">):</span>
        <span class="n">Monday</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">Monday</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">Tuesday</span> <span class="o">=</span> <span class="bp">False</span><span class="p">;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Tuesday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Tuesday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Tuesday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Tuesday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;on&quot;</span><span class="p">):</span>
        <span class="n">Tuesday</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">Tuesday</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">Wednesday</span> <span class="o">=</span> <span class="bp">False</span><span class="p">;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Wednesday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Wednesday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Wednesday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Wednesday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;on&quot;</span><span class="p">):</span>
        <span class="n">Wednesday</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">Wednesday</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">Thursday</span> <span class="o">=</span> <span class="bp">False</span><span class="p">;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Thursday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Thursday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Thursday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Thursday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;on&quot;</span><span class="p">):</span>
        <span class="n">Thursday</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">Thursday</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">Friday</span> <span class="o">=</span> <span class="bp">False</span><span class="p">;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Friday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Friday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Friday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Friday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;on&quot;</span><span class="p">):</span>
        <span class="n">Friday</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">Friday</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">Saturday</span> <span class="o">=</span> <span class="bp">False</span><span class="p">;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Saturday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Saturday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Saturday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Saturday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;on&quot;</span><span class="p">):</span>
        <span class="n">Saturday</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">Saturday</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">Sunday</span> <span class="o">=</span> <span class="bp">False</span><span class="p">;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Sunday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Sunday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Sunday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Sunday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;on&quot;</span><span class="p">):</span>
        <span class="n">Sunday</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">Sunday</span> <span class="o">=</span> <span class="bp">False</span><span class="p">;</span>

    <span class="n">insertPrescription</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span>
        <span class="n">medication</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;medication&#39;</span><span class="p">],</span>
        <span class="n">dosage</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;dosage&#39;</span><span class="p">],</span>
        <span class="n">frequency</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;frequency&#39;</span><span class="p">],</span>
        <span class="n">quantity</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;quantity&#39;</span><span class="p">],</span>
        <span class="n">dosageunit</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;dosageunit&#39;</span><span class="p">],</span>
        <span class="n">startdate</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">],</span>
        <span class="n">enddate</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">],</span>
        <span class="n">stockleft</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;stockleft&#39;</span><span class="p">],</span>
        <span class="n">prerequisite</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;prerequisite&#39;</span><span class="p">],</span>
        <span class="n">dosageform</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;dosageform&#39;</span><span class="p">],</span>
        <span class="n">Monday</span> <span class="o">=</span> <span class="n">Monday</span><span class="p">,</span>
        <span class="n">Tuesday</span> <span class="o">=</span> <span class="n">Tuesday</span><span class="p">,</span>
        <span class="n">Wednesday</span> <span class="o">=</span> <span class="n">Wednesday</span><span class="p">,</span>
        <span class="n">Thursday</span> <span class="o">=</span> <span class="n">Thursday</span><span class="p">,</span>
        <span class="n">Friday</span> <span class="o">=</span> <span class="n">Friday</span><span class="p">,</span>
        <span class="n">Saturday</span> <span class="o">=</span> <span class="n">Saturday</span><span class="p">,</span>
        <span class="n">Sunday</span>  <span class="o">=</span> <span class="n">Sunday</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">insertPrescription</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="n">createNotificationRecord</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="s">&quot;Prescription Added&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;medication&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;dosage&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;dosageunit&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;  added for &quot;</span> <span class="o">+</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
        
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/editPrescription&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">editPrescription</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">getUsernameFromHeader</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">editPrescription</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">editPrescription</span><span class="p">(</span><span class="n">details</span><span class="p">):</span>
    <span class="n">Monday</span> <span class="o">=</span> <span class="bp">False</span><span class="p">;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Monday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Monday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Monday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Monday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;on&quot;</span><span class="p">):</span>
        <span class="n">Monday</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">Monday</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">Tuesday</span> <span class="o">=</span> <span class="bp">False</span><span class="p">;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Tuesday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Tuesday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Tuesday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Tuesday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;on&quot;</span><span class="p">):</span>
        <span class="n">Tuesday</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">Tuesday</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">Wednesday</span> <span class="o">=</span> <span class="bp">False</span><span class="p">;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Wednesday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Wednesday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Wednesday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Wednesday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;on&quot;</span><span class="p">):</span>
        <span class="n">Wednesday</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">Wednesday</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">Thursday</span> <span class="o">=</span> <span class="bp">False</span><span class="p">;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Thursday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Thursday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Thursday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Thursday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;on&quot;</span><span class="p">):</span>
        <span class="n">Thursday</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">Thursday</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">Friday</span> <span class="o">=</span> <span class="bp">False</span><span class="p">;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Friday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Friday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Friday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Friday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;on&quot;</span><span class="p">):</span>
        <span class="n">Friday</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">Friday</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">Saturday</span> <span class="o">=</span> <span class="bp">False</span><span class="p">;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Saturday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Saturday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Saturday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Saturday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;on&quot;</span><span class="p">):</span>
        <span class="n">Saturday</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">Saturday</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">Sunday</span> <span class="o">=</span> <span class="bp">False</span><span class="p">;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Sunday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Sunday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Sunday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;Sunday&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;on&quot;</span><span class="p">):</span>
        <span class="n">Sunday</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">Sunday</span> <span class="o">=</span> <span class="bp">False</span><span class="p">;</span>

    <span class="n">updatePrescription</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">medication</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;medication&#39;</span><span class="p">],</span>
        <span class="n">dosage</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;dosage&#39;</span><span class="p">],</span>
        <span class="n">frequency</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;frequency&#39;</span><span class="p">],</span>
        <span class="n">quantity</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;quantity&#39;</span><span class="p">],</span>
        <span class="n">dosageunit</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;dosageunit&#39;</span><span class="p">],</span>
        <span class="n">startdate</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">],</span>
        <span class="n">enddate</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">],</span>
        <span class="n">stockleft</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;stockleft&#39;</span><span class="p">],</span>
        <span class="n">prerequisite</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;prerequisite&#39;</span><span class="p">],</span>
        <span class="n">dosageform</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;dosageform&#39;</span><span class="p">],</span>
        <span class="n">Monday</span> <span class="o">=</span> <span class="n">Monday</span><span class="p">,</span>
        <span class="n">Tuesday</span> <span class="o">=</span> <span class="n">Tuesday</span><span class="p">,</span>
        <span class="n">Wednesday</span> <span class="o">=</span> <span class="n">Wednesday</span><span class="p">,</span>
        <span class="n">Thursday</span> <span class="o">=</span> <span class="n">Thursday</span><span class="p">,</span>
        <span class="n">Friday</span> <span class="o">=</span> <span class="n">Friday</span><span class="p">,</span>
        <span class="n">Saturday</span> <span class="o">=</span> <span class="n">Saturday</span><span class="p">,</span>
        <span class="n">Sunday</span> <span class="o">=</span> <span class="n">Sunday</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;prescriptionid&#39;</span><span class="p">])</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">updatePrescription</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="n">patient</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;prescriptionid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">createNotificationRecord</span><span class="p">(</span><span class="n">patient</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&quot;Prescription Updated&quot;</span><span class="p">,</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;prescriptionid&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;medication&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;dosage&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;dosageunit&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;  updated for &quot;</span> <span class="o">+</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;Failed&quot;</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/deletePrescription&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">deletePrescription</span><span class="p">():</span>
    <span class="n">prescription</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;prescriptionid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">patient</span> <span class="o">=</span> <span class="n">prescription</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">username</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">getUsernameFromHeader</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">patient</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">deletePrescription</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;prescriptionid&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="deletePrescription"><a class="viewcode-back" href="../../api.html#justHealthServer.api.deletePrescription">[docs]</a><span class="k">def</span> <span class="nf">deletePrescription</span><span class="p">(</span><span class="n">prescriptionid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes a specified prescriptions. </span>

<span class="sd">    :param prescriptionid: The id of the prescription to delete. </span>
<span class="sd">    :type prescriptionid: int. </span>

<span class="sd">    :returns: str -- &#39;Deleted&#39; or &#39;Failed&#39;. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">prescriptionid</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;Failed&quot;</span>
    <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&quot;Deleted&quot;</span>
    <span class="k">return</span> <span class="s">&quot;Failed&quot;</span>

</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/getPrescriptions&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">getPrescriptions</span><span class="p">():</span>
    <span class="n">getAccountType</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">getUsernameFromHeader</span><span class="p">()))[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">getAccountType</span> <span class="o">==</span> <span class="s">&quot;Carer&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">getUsernameFromHeader</span><span class="p">(),</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">getPrescriptions</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">getAccountType</span> <span class="o">==</span> <span class="s">&quot;Patient&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">getPrescriptions</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="getPrescriptions"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getPrescriptions">[docs]</a><span class="k">def</span> <span class="nf">getPrescriptions</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all (active, upcoming and expired) prescriptions for a specified user. </span>

<span class="sd">    :param username: The user to check for. </span>
<span class="sd">    :type username: str. </span>

<span class="sd">    :returns: json -- The list of prescriptions. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">accountType</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">username</span><span class="p">))[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">accountType</span> <span class="o">==</span> <span class="s">&quot;Patient&quot;</span><span class="p">:</span>
        <span class="n">jsonResult</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">user</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">])</span>
            <span class="n">result</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">])</span>
            <span class="n">jsonResult</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">jsonResult</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;Must have Patient account type&quot;</span>

<span class="c">#UpToHere</span></div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/getActivePrescriptions&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">getActivePrescriptions</span><span class="p">():</span>
    <span class="n">getAccountType</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">getUsernameFromHeader</span><span class="p">()))[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">getAccountType</span> <span class="o">==</span> <span class="s">&quot;Carer&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">getUsernameFromHeader</span><span class="p">(),</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">getActivePrescriptions</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">getAccountType</span> <span class="o">==</span> <span class="s">&quot;Patient&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">getActivePrescriptions</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="getActivePrescriptions"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getActivePrescriptions">[docs]</a><span class="k">def</span> <span class="nf">getActivePrescriptions</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all active prescriptions for a specified user. </span>

<span class="sd">    :param username: The specified user. </span>
<span class="sd">    :type username: str. </span>

<span class="sd">    :returns: json -- List of prescriptions. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">allPrescriptions</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getPrescriptions</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">prescription</span> <span class="k">for</span> <span class="n">prescription</span> <span class="ow">in</span> <span class="n">allPrescriptions</span> <span class="k">if</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">prescription</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">],</span> <span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="ow">and</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">prescription</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">],</span> <span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())])</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/getUpcomingPrescriptions&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">getUpcomingPrescriptions</span><span class="p">():</span>
    <span class="n">getAccountType</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">getUsernameFromHeader</span><span class="p">()))[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">getAccountType</span> <span class="o">==</span> <span class="s">&quot;Carer&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">getUsernameFromHeader</span><span class="p">(),</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">getUpcomingPrescriptions</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">getAccountType</span> <span class="o">==</span> <span class="s">&quot;Patient&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">getUpcomingPrescriptions</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="getUpcomingPrescriptions"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getUpcomingPrescriptions">[docs]</a><span class="k">def</span> <span class="nf">getUpcomingPrescriptions</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all upcoming prescriptions for a specified user. </span>

<span class="sd">    :param username: The username to check for. </span>
<span class="sd">    :type username: str.</span>

<span class="sd">    :returns: json -- List of prescriptions. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">allPrescriptions</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getPrescriptions</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">prescription</span> <span class="k">for</span> <span class="n">prescription</span> <span class="ow">in</span> <span class="n">allPrescriptions</span> <span class="k">if</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">prescription</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">],</span> <span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())])</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/getExpiredPrescriptions&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">getExpiredPrescriptions</span><span class="p">():</span>
    <span class="n">getAccountType</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">getUsernameFromHeader</span><span class="p">()))[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">getAccountType</span> <span class="o">==</span> <span class="s">&quot;Carer&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">getUsernameFromHeader</span><span class="p">(),</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">getExpiredPrescriptions</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">getAccountType</span> <span class="o">==</span> <span class="s">&quot;Patient&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">getExpiredPrescriptions</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="getExpiredPrescriptions"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getExpiredPrescriptions">[docs]</a><span class="k">def</span> <span class="nf">getExpiredPrescriptions</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all expired prescriptions for a specified user. </span>

<span class="sd">    :param username: The username to check for. </span>
<span class="sd">    :type username: str. </span>

<span class="sd">    :returns: json -- List of expired prescriptions. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">allPrescriptions</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getPrescriptions</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">prescription</span> <span class="k">for</span> <span class="n">prescription</span> <span class="ow">in</span> <span class="n">allPrescriptions</span> <span class="k">if</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">prescription</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">],</span> <span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())])</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/getPrescription&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">getPrescription</span><span class="p">():</span>
    <span class="n">getAccountType</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">getAccountInfo</span><span class="p">(</span><span class="n">getUsernameFromHeader</span><span class="p">()))[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">getAccountType</span> <span class="o">==</span> <span class="s">&quot;Carer&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">getUsernameFromHeader</span><span class="p">(),</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">getExpiredPrescriptions</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">getAccountType</span> <span class="o">==</span> <span class="s">&quot;Patient&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">getPrescription</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>

<div class="viewcode-block" id="getPrescription"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getPrescription">[docs]</a><span class="k">def</span> <span class="nf">getPrescription</span><span class="p">(</span><span class="n">details</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the details of a specified prescription. </span>

<span class="sd">    :param details: Dictionary containing [prescriptionid]. </span>
<span class="sd">    :type details: dict. </span>

<span class="sd">    :returns: json -- Details of prescription. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prescriptionid</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;prescriptionid&#39;</span><span class="p">]</span>
    <span class="n">prescription</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">prescriptionid</span><span class="p">)</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">prescription</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">prescription</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">])</span>
    <span class="n">prescription</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">prescription</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">prescription</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/takeprescription&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">takePrescription</span><span class="p">():</span>
    <span class="n">prescriptionid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;prescriptionid&#39;</span><span class="p">]</span>
    <span class="n">prescription</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">prescriptionid</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">prescription</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">takePrescription</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>

<div class="viewcode-block" id="takePrescription"><a class="viewcode-back" href="../../api.html#justHealthServer.api.takePrescription">[docs]</a><span class="k">def</span> <span class="nf">takePrescription</span><span class="p">(</span><span class="n">details</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Allows a prescription to be taken. </span>

<span class="sd">    :param details: Dictionary containing [currentcount] (number taken today), [prescriptionid].</span>
<span class="sd">    :type details: dict. </span>

<span class="sd">    :returns: True for success or &#39;Invalid current count&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">currentCount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;currentcount&#39;</span><span class="p">])</span>
        <span class="c"># If a record already exists for this day, update</span>
        <span class="n">takeInstance</span> <span class="o">=</span> <span class="n">TakePrescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">TakePrescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;prescriptionid&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TakePrescription</span><span class="o">.</span><span class="n">currentdate</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()))</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">takeInstance</span> <span class="o">=</span> <span class="n">TakePrescription</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">currentcount</span> <span class="o">=</span> <span class="n">currentCount</span>
        <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">TakePrescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;prescriptionid&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">TakePrescription</span><span class="o">.</span><span class="n">currentdate</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
            <span class="n">takeInstance</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="n">checkStockLevel</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;prescriptionid&#39;</span><span class="p">],</span> <span class="n">currentCount</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">&quot;True&quot;</span>
    <span class="k">except</span> <span class="n">TakePrescription</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="c"># No record exists for today, create a new one</span>
        <span class="n">takeInstance</span> <span class="o">=</span> <span class="n">TakePrescription</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
            <span class="n">prescriptionid</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;prescriptionid&#39;</span><span class="p">],</span>
            <span class="n">currentcount</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;currentcount&#39;</span><span class="p">],</span>
            <span class="n">startingcount</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;prescriptionid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">stockleft</span><span class="p">,</span>
            <span class="n">currentdate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
        <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
            <span class="n">takeInstance</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="n">checkStockLevel</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s">&#39;prescriptionid&#39;</span><span class="p">],</span> <span class="n">currentCount</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">&quot;True&quot;</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;Invalid current count (is it an integer?)&quot;</span>
    <span class="k">return</span> <span class="s">&quot;False&quot;</span>
</div>
<div class="viewcode-block" id="checkStockLevel"><a class="viewcode-back" href="../../api.html#justHealthServer.api.checkStockLevel">[docs]</a><span class="k">def</span> <span class="nf">checkStockLevel</span><span class="p">(</span><span class="n">prescription</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the stock level of a prescription after taking.</span>
<span class="sd">    Creates a notification is appropriate. </span>

<span class="sd">    :param prescription: The id of the prescription. </span>
<span class="sd">    :type prescription: int. </span>

<span class="sd">    :param count: The amount just taken.</span>
<span class="sd">    :type count: int. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">thisPrescription</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">prescription</span><span class="p">)</span>
    <span class="n">takeInstance</span> <span class="o">=</span> <span class="n">TakePrescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="p">(</span><span class="n">TakePrescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">prescription</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">TakePrescription</span><span class="o">.</span><span class="n">currentdate</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
    <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    
    <span class="c"># Level to decrease stock by is number of times taken today * number of tablets etc. taken each time</span>
    <span class="n">levelToDecrease</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="n">thisPrescription</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
    
    <span class="c"># If they have increased their stock, reflect that change</span>
    <span class="k">if</span> <span class="n">thisPrescription</span><span class="o">.</span><span class="n">stockleft</span> <span class="o">&gt;</span> <span class="n">takeInstance</span><span class="o">.</span><span class="n">startingcount</span><span class="p">:</span>
        <span class="n">takeInstance</span><span class="o">.</span><span class="n">startingcount</span> <span class="o">=</span> <span class="n">thisPrescription</span><span class="o">.</span><span class="n">stockleft</span>
    
    <span class="c"># Remove the amount taken today from stock</span>
    <span class="n">thisPrescription</span><span class="o">.</span><span class="n">stockleft</span> <span class="o">=</span> <span class="p">(</span><span class="n">takeInstance</span><span class="o">.</span><span class="n">startingcount</span> <span class="o">-</span> <span class="n">levelToDecrease</span><span class="p">)</span>
    
    <span class="c"># Commit all changes</span>
    <span class="n">thisPrescription</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="c"># Do they have 3 days worth?</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">thisPrescription</span><span class="o">.</span><span class="n">stockleft</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">thisPrescription</span><span class="o">.</span><span class="n">frequency</span> <span class="o">*</span> <span class="n">thisPrescription</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">)):</span>
        <span class="n">patient</span> <span class="o">=</span> <span class="n">thisPrescription</span><span class="o">.</span><span class="n">username</span>
        <span class="n">carer</span> <span class="o">=</span> <span class="n">Patientcarer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Patientcarer</span><span class="o">.</span><span class="n">patient</span> <span class="o">==</span> <span class="n">patient</span><span class="p">)</span><span class="o">.</span><span class="n">carer</span>
        <span class="c"># Has the patient currently been alerted?</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">Notification</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">Notification</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">patient</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                    <span class="n">Notification</span><span class="o">.</span><span class="n">notificationtype</span> <span class="o">==</span> <span class="s">&quot;Medication Low&quot;</span><span class="p">,</span>
                    <span class="n">Notification</span><span class="o">.</span><span class="n">relatedObject</span> <span class="o">==</span> <span class="n">thisPrescription</span><span class="o">.</span><span class="n">prescriptionid</span><span class="p">,</span>
                    <span class="n">Notification</span><span class="o">.</span><span class="n">dismissed</span> <span class="o">==</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="n">Notification</span><span class="o">.</span><span class="n">relatedObjectTable</span> <span class="o">==</span> <span class="s">&quot;Prescription&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">Notification</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">createNotificationRecord</span><span class="p">(</span><span class="n">patient</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&quot;Medication Low&quot;</span><span class="p">,</span> <span class="n">thisPrescription</span><span class="o">.</span><span class="n">prescriptionid</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">Notification</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">Notification</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">carer</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                    <span class="n">Notification</span><span class="o">.</span><span class="n">notificationtype</span> <span class="o">==</span> <span class="s">&quot;Patient Medication Low&quot;</span><span class="p">,</span>
                    <span class="n">Notification</span><span class="o">.</span><span class="n">relatedObject</span> <span class="o">==</span> <span class="n">thisPrescription</span><span class="o">.</span><span class="n">prescriptionid</span><span class="p">,</span>
                    <span class="n">Notification</span><span class="o">.</span><span class="n">dismissed</span> <span class="o">==</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="n">Notification</span><span class="o">.</span><span class="n">relatedObjectTable</span> <span class="o">==</span> <span class="s">&quot;Prescription&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">Notification</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">createNotificationRecord</span><span class="p">(</span><span class="n">carer</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&quot;Patient Medication Low&quot;</span><span class="p">,</span> <span class="n">thisPrescription</span><span class="o">.</span><span class="n">prescriptionid</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/getPrescriptionCount&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">getPrescriptionCount</span><span class="p">():</span>
    <span class="n">prescriptionid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;prescriptionid&#39;</span><span class="p">]</span>
    <span class="n">prescription</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">prescriptionid</span><span class="p">)</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">prescription</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">getPrescriptionCount</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>

<div class="viewcode-block" id="getPrescriptionCount"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getPrescriptionCount">[docs]</a><span class="k">def</span> <span class="nf">getPrescriptionCount</span><span class="p">(</span><span class="n">details</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the number of times a user has taken a prescription on the current day.</span>

<span class="sd">    :param details: Dictionary containing [prescriptionid].</span>
<span class="sd">    :type details: dict. </span>

<span class="sd">    :returns: int -- The count. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">takeInstance</span> <span class="o">=</span> <span class="n">TakePrescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="p">(</span><span class="n">TakePrescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;prescriptionid&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="n">TakePrescription</span><span class="o">.</span><span class="n">currentdate</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()))</span> \
            <span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">takeInstance</span><span class="o">.</span><span class="n">currentcount</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">TakePrescription</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/searchNHSDirectWebsite&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">searchNHSDirect</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">searchNHSDirect</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;searchterms&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="searchNHSDirect"><a class="viewcode-back" href="../../api.html#justHealthServer.api.searchNHSDirect">[docs]</a><span class="k">def</span> <span class="nf">searchNHSDirect</span><span class="p">(</span><span class="n">search</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allows a search term to be passed to the NHS website. </span>

<span class="sd">    :param search: The search term. </span>
<span class="sd">    :type search: str. </span>

<span class="sd">    :returns: str -- The url of the website. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">newTerm</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;+&quot;</span><span class="p">)</span>
    <span class="n">website</span> <span class="o">=</span> <span class="s">&quot;http://www.nhs.uk/Search/Pages/Results.aspx?___JSSniffer=true&amp;q=&quot;</span>
    <span class="n">searchWeb</span> <span class="o">=</span> <span class="n">website</span> <span class="o">+</span> <span class="n">newTerm</span>
    <span class="k">return</span> <span class="n">searchWeb</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/getDeactivateReasons&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">getDeactivateReasons</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">getDeactivateReasons</span><span class="p">()</span>

<div class="viewcode-block" id="getDeactivateReasons"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getDeactivateReasons">[docs]</a><span class="k">def</span> <span class="nf">getDeactivateReasons</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of possible reasons a user can deactivate</span>

<span class="sd">    :returns: json -- List of possible reasons.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reasons</span> <span class="o">=</span> <span class="n">Deactivatereason</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
    <span class="n">reasonList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">reason</span> <span class="ow">in</span> <span class="n">reasons</span><span class="p">:</span>
        <span class="n">reasonList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reason</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
    <span class="n">reasonList</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">reasonList</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">reasonList</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/getAppointmentTypes&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">getAppointmentTypes</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">getAppointmentTypes</span><span class="p">()</span>

<div class="viewcode-block" id="getAppointmentTypes"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getAppointmentTypes">[docs]</a><span class="k">def</span> <span class="nf">getAppointmentTypes</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of possible appointment types</span>

<span class="sd">    :returns: json -- List of appointment types</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">types</span> <span class="o">=</span> <span class="n">Appointmenttype</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
    <span class="n">typeList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">appType</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
      <span class="n">typeList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">appType</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
    <span class="n">typeList</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">typeList</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">typeList</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/getCorrespondence&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">getCorrespondence</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;carer&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;patient&#39;</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">getCorrespondence</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;carer&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;patient&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="getCorrespondence"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getCorrespondence">[docs]</a><span class="k">def</span> <span class="nf">getCorrespondence</span><span class="p">(</span><span class="n">carer</span><span class="p">,</span> <span class="n">patient</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all notes for a patient/carer relationship. </span>
<span class="sd">    </span>
<span class="sd">    :param carer: The username of the carer. </span>
<span class="sd">    :type carer: str.</span>

<span class="sd">    :param patient: The username of the patient. </span>
<span class="sd">    :type patient: str. </span>

<span class="sd">    :returns: json -- List of notes. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">allNotes</span> <span class="o">=</span> <span class="n">Notes</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">Notes</span><span class="o">.</span><span class="n">carer</span> <span class="o">==</span> <span class="n">carer</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Notes</span><span class="o">.</span><span class="n">patient</span> <span class="o">==</span> <span class="n">patient</span><span class="p">))</span>
     
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">allNotes</span><span class="p">:</span>
        <span class="n">note</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">note</span><span class="p">[</span><span class="s">&#39;noteid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">noteid</span>
        <span class="n">note</span><span class="p">[</span><span class="s">&#39;carer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">carer</span><span class="o">.</span><span class="n">username</span>
        <span class="n">note</span><span class="p">[</span><span class="s">&#39;patient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">username</span>
        <span class="n">note</span><span class="p">[</span><span class="s">&#39;notes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">notes</span>
        <span class="n">note</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">title</span>
        <span class="n">note</span><span class="p">[</span><span class="s">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">note</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/getPatientNotes&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">getPatientNotes</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">getPatientNotes</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>

<div class="viewcode-block" id="getPatientNotes"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getPatientNotes">[docs]</a><span class="k">def</span> <span class="nf">getPatientNotes</span><span class="p">(</span><span class="n">details</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all notes for a specific patient. </span>

<span class="sd">    :param details: Dictionary containing [username] of target patient. </span>
<span class="sd">    :type details: dict. </span>

<span class="sd">    :returns: json -- List of notes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">allNotes</span> <span class="o">=</span> <span class="n">Notes</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Notes</span><span class="o">.</span><span class="n">patient</span> <span class="o">==</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>
     
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">allNotes</span><span class="p">:</span>
        <span class="n">note</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">note</span><span class="p">[</span><span class="s">&#39;noteid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">noteid</span>
        <span class="n">note</span><span class="p">[</span><span class="s">&#39;carer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">carer</span><span class="o">.</span><span class="n">username</span>
        <span class="n">note</span><span class="p">[</span><span class="s">&#39;patient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">username</span>
        <span class="n">note</span><span class="p">[</span><span class="s">&#39;notes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">notes</span>
        <span class="n">note</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">title</span>
        <span class="n">note</span><span class="p">[</span><span class="s">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">note</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/addCorrespondence&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">addCorrespondence</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;carer&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;patient&#39;</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">addCorrespondence</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>

<div class="viewcode-block" id="addCorrespondence"><a class="viewcode-back" href="../../api.html#justHealthServer.api.addCorrespondence">[docs]</a><span class="k">def</span> <span class="nf">addCorrespondence</span><span class="p">(</span><span class="n">details</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a note for a patient. </span>

<span class="sd">    :param details: Dictionary containing [carer], [patient], [notes] (note content), [title]. </span>
<span class="sd">    :type details: dict. </span>

<span class="sd">    :returns: str -- True or False for success. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">insert</span> <span class="o">=</span> <span class="n">Notes</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
        <span class="n">carer</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;carer&#39;</span><span class="p">],</span>
        <span class="n">patient</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;patient&#39;</span><span class="p">],</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;notes&#39;</span><span class="p">],</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">],</span>
        <span class="n">datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="p">)</span>
    
    <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
        <span class="n">insert</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&quot;True&quot;</span>
    <span class="k">return</span> <span class="s">&quot;False&quot;</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/deleteNote&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">deleteNote</span><span class="p">():</span>
    <span class="n">note</span> <span class="o">=</span> <span class="n">Notes</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Notes</span><span class="o">.</span><span class="n">noteid</span> <span class="o">==</span> <span class="n">noteid</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">patient</span> <span class="o">=</span> <span class="n">note</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">username</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">getUsernameFromHeader</span><span class="p">(),</span> <span class="n">patient</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">deleteNote</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;noteid&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="deleteNote"><a class="viewcode-back" href="../../api.html#justHealthServer.api.deleteNote">[docs]</a><span class="k">def</span> <span class="nf">deleteNote</span><span class="p">(</span><span class="n">noteid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete a specific note</span>

<span class="sd">    :param noteid: The id of the note to delete. </span>
<span class="sd">    :type noteid: int. </span>

<span class="sd">    :returns: str - Either &#39;Deleted&#39; or &#39;Failed&#39;. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">Notes</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Notes</span><span class="o">.</span><span class="n">noteid</span> <span class="o">==</span> <span class="n">noteid</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
            <span class="k">return</span> <span class="s">&quot;Deleted&quot;</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;Failed&quot;</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/addAndroidEventId&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<div class="viewcode-block" id="addAndroidEventId"><a class="viewcode-back" href="../../api.html#justHealthServer.api.addAndroidEventId">[docs]</a><span class="k">def</span> <span class="nf">addAndroidEventId</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allows an android event id of a calendar event to be stored. </span>

<span class="sd">    :param request.form: POST request containing [dbid](id of event) and [androidid](the android event id). </span>
<span class="sd">    :type request.form: dict. </span>

<span class="sd">    :returns: str -- Success message</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dbId</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;dbid&#39;</span><span class="p">]</span>
    <span class="n">androidId</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;androidid&#39;</span><span class="p">]</span>
    <span class="n">addAndroidId</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">androideventid</span><span class="o">=</span><span class="n">androidId</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">appid</span><span class="o">==</span><span class="n">dbId</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
    <span class="k">return</span> <span class="s">&quot;Android ID added to database&quot;</span>

<span class="c">##</span>
<span class="c">#Admin Portal Pages</span>
<span class="c">##</span></div>
<div class="viewcode-block" id="addDeactivate"><a class="viewcode-back" href="../../api.html#justHealthServer.api.addDeactivate">[docs]</a><span class="k">def</span> <span class="nf">addDeactivate</span><span class="p">(</span><span class="n">reason</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allows a new add deactivate reasons to be added to the database. </span>

<span class="sd">    :param reason: The reason to add. </span>
<span class="sd">    :type reason: str. </span>

<span class="sd">    :returns: str -- True or False for success. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">insert</span> <span class="o">=</span> <span class="n">Deactivatereason</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;reason&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    
    <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
        <span class="n">insert</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&quot;True&quot;</span>
    <span class="k">return</span> <span class="s">&quot;False&quot;</span>
</div>
<div class="viewcode-block" id="newMedication"><a class="viewcode-back" href="../../api.html#justHealthServer.api.newMedication">[docs]</a><span class="k">def</span> <span class="nf">newMedication</span><span class="p">(</span><span class="n">medication</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allows a new medication to be inserted into the database. </span>

<span class="sd">    :param medication: The name of the medication to add. </span>
<span class="sd">    :type medication: str.</span>

<span class="sd">    :returns: str -- True or False. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">insert</span> <span class="o">=</span> <span class="n">Medication</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;medication&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    
    <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
        <span class="n">insert</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&quot;True&quot;</span>
    <span class="k">return</span> <span class="s">&quot;False&quot;</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/getReasons&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">getReasons</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">getReasons</span><span class="p">()</span>

<div class="viewcode-block" id="getReasons"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getReasons">[docs]</a><span class="k">def</span> <span class="nf">getReasons</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all pre-set reasons to deactivate.</span>

<span class="sd">    :returns: json -- List of reasons. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">Userdeactivatereason</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
    <span class="n">reasons</span> <span class="o">=</span> <span class="n">Userdeactivatereason</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Userdeactivatereason</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">reason</span> <span class="ow">in</span> <span class="n">reasons</span><span class="p">:</span>
      <span class="n">result</span><span class="p">[</span><span class="n">reason</span><span class="o">.</span><span class="n">reason</span><span class="o">.</span><span class="n">reason</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Userdeactivatereason</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="n">reason</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="getAllUsers"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getAllUsers">[docs]</a><span class="k">def</span> <span class="nf">getAllUsers</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns information about all users. </span>

<span class="sd">    :returns: json -- List containing dictionaries representing all users. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">Client</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span><span class="p">):</span>
        <span class="n">userDetails</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">Admin</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Client</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span><span class="o">==</span><span class="n">u</span><span class="o">.</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">userDetails</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Admin&quot;</span>
        <span class="k">except</span> <span class="n">Admin</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">Carer</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Client</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span><span class="o">==</span><span class="n">u</span><span class="o">.</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="n">userDetails</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Carer&quot;</span>
            <span class="k">except</span> <span class="n">Carer</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">Patient</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Client</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span><span class="o">==</span><span class="n">u</span><span class="o">.</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="n">userDetails</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Patient&quot;</span>
    
            <span class="n">userDetails</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">firstname</span>
            <span class="n">userDetails</span><span class="p">[</span><span class="s">&#39;surname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">surname</span>
            <span class="n">userDetails</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">username</span>
            <span class="n">userDetails</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">email</span>
            <span class="n">userDetails</span><span class="p">[</span><span class="s">&#39;dob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">dob</span><span class="p">)</span>
            <span class="n">userDetails</span><span class="p">[</span><span class="s">&#39;accountdeactivated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">accountdeactivated</span>
            <span class="n">userDetails</span><span class="p">[</span><span class="s">&#39;accountlocked&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">accountlocked</span>
            <span class="n">userDetails</span><span class="p">[</span><span class="s">&#39;loginattempts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">loginattempts</span>
            <span class="n">userDetails</span><span class="p">[</span><span class="s">&#39;verified&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">verified</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">ismale</span><span class="p">:</span>
                <span class="n">userDetails</span><span class="p">[</span><span class="s">&#39;gender&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Male&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">userDetails</span><span class="p">[</span><span class="s">&#39;gender&#39;</span><span class="p">]</span> <span class="o">=</span><span class="s">&#39;Female&#39;</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">userDetails</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c">#Update user account settings in Admin Portal</span></div>
<div class="viewcode-block" id="updateAccountSettings"><a class="viewcode-back" href="../../api.html#justHealthServer.api.updateAccountSettings">[docs]</a><span class="k">def</span> <span class="nf">updateAccountSettings</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">accountlocked</span><span class="p">,</span> <span class="n">accountdeactivated</span><span class="p">,</span> <span class="n">verified</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allows an admin to alter a user&#39;s account settings. </span>

<span class="sd">    :param settings: Dictionary of users settings [username, ismale, firstname, surname, email, dob,</span>
<span class="sd">                    accounttype, loginattempts]. </span>
<span class="sd">    :type settings: dict. </span>

<span class="sd">    :param accountlocked: Whether the account should be locked or not. </span>
<span class="sd">    :type accountlocked: boolean. </span>

<span class="sd">    :param verified: Whether the account is verified. </span>
<span class="sd">    :type verified: boolean.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># What type of user are we dealing with?</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">Admin</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Client</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span><span class="o">==</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">Admin</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">Carer</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Client</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span><span class="o">==</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">Carer</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">Patient</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Client</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span><span class="o">==</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="c"># Access to their corresponding Client entry</span>
    <span class="n">clientObject</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="n">gender</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;ismale&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">:</span>
        <span class="n">gender</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c"># Update</span>
    <span class="n">user</span><span class="o">.</span><span class="n">firstname</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">]</span>
    <span class="n">user</span><span class="o">.</span><span class="n">surname</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;surname&#39;</span><span class="p">]</span>
    <span class="n">user</span><span class="o">.</span><span class="n">ismale</span> <span class="o">=</span> <span class="n">gender</span>

    <span class="n">clientObject</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
    <span class="n">clientObject</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span>
    <span class="n">clientObject</span><span class="o">.</span><span class="n">dob</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;dob&#39;</span><span class="p">]</span>
    <span class="n">clientObject</span><span class="o">.</span><span class="n">accounttype</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;accounttype&#39;</span><span class="p">]</span>
    <span class="n">clientObject</span><span class="o">.</span><span class="n">accountdeactivated</span> <span class="o">=</span> <span class="n">accountdeactivated</span>
    <span class="n">clientObject</span><span class="o">.</span><span class="n">accountlocked</span> <span class="o">=</span> <span class="n">accountlocked</span>
    <span class="n">clientObject</span><span class="o">.</span><span class="n">loginattempts</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;loginattempts&#39;</span><span class="p">]</span>
    <span class="n">clientObject</span><span class="o">.</span><span class="n">verified</span> <span class="o">=</span> <span class="n">verified</span>

    <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
        <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">clientObject</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&quot;True&quot;</span>
    <span class="k">return</span> <span class="s">&quot;False&quot;</span>
</div>
<div class="viewcode-block" id="deleteAccount"><a class="viewcode-back" href="../../api.html#justHealthServer.api.deleteAccount">[docs]</a><span class="k">def</span> <span class="nf">deleteAccount</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes a user&#39;s account. </span>

<span class="sd">    :param username: The username who&#39;s account should be deleted. </span>
<span class="sd">    :type username: str. </span>

<span class="sd">    :returns: str -- &#39;Deleted&#39; if successful, else &#39;Failed&#39;. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;Failed&quot;</span>
    <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&quot;Deleted&quot;</span>
    <span class="k">return</span> <span class="s">&quot;Failed&quot;</span>
</div>
<div class="viewcode-block" id="createNotificationRecord"><a class="viewcode-back" href="../../api.html#justHealthServer.api.createNotificationRecord">[docs]</a><span class="k">def</span> <span class="nf">createNotificationRecord</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">notificationType</span><span class="p">,</span> <span class="n">relatedObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a notification on the JustHealth platform. </span>

<span class="sd">    :param user: The user the notification belongs to. </span>
<span class="sd">    :type user: str. </span>

<span class="sd">    :param notificationType: The type of notification to be created</span>
<span class="sd">    :type notificationType: str. </span>

<span class="sd">    :param relatedObject: The resource a notification pertains to, if any. </span>
<span class="sd">    :type relatedObject: int. </span>

<span class="sd">    :returns: str -- &#39;True&#39; if successful, else &#39;False&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Dictionary mapping notificationType to referencing table</span>
    <span class="n">notificationTypeTable</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">notificationTypeTable</span><span class="p">[</span><span class="s">&#39;Connection Request&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Relationship&quot;</span>
    <span class="n">notificationTypeTable</span><span class="p">[</span><span class="s">&#39;New Connection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="n">notificationTypeTable</span><span class="p">[</span><span class="s">&#39;Prescription Added&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Prescription&quot;</span>
    <span class="n">notificationTypeTable</span><span class="p">[</span><span class="s">&#39;Prescription Updated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Prescription&quot;</span>
    <span class="n">notificationTypeTable</span><span class="p">[</span><span class="s">&#39;Appointment Invite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Appointments&quot;</span>
    <span class="n">notificationTypeTable</span><span class="p">[</span><span class="s">&#39;Appointment Updated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Appointments&quot;</span>
    <span class="n">notificationTypeTable</span><span class="p">[</span><span class="s">&#39;Appointment Cancelled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="n">notificationTypeTable</span><span class="p">[</span><span class="s">&#39;Password Reset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="n">notificationTypeTable</span><span class="p">[</span><span class="s">&#39;Appointment Declined&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Appointments&quot;</span>
    <span class="n">notificationTypeTable</span><span class="p">[</span><span class="s">&#39;Appointment Accepted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Appointments&quot;</span>
    <span class="n">notificationTypeTable</span><span class="p">[</span><span class="s">&#39;Patient Medication Low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Prescription&quot;</span>
    <span class="n">notificationTypeTable</span><span class="p">[</span><span class="s">&#39;Medication Low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Prescription&quot;</span>
    <span class="n">notificationTypeTable</span><span class="p">[</span><span class="s">&#39;Missed Prescription&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;TakePrescription&quot;</span>
    <span class="n">notificationTypeTable</span><span class="p">[</span><span class="s">&#39;Carer Missed Prescription&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;TakePrescription&quot;</span>

    <span class="n">createNotification</span> <span class="o">=</span> <span class="n">Notification</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">user</span><span class="p">,</span>
        <span class="n">notificationtype</span> <span class="o">=</span> <span class="n">notificationType</span><span class="p">,</span>
        <span class="n">relatedObjectTable</span> <span class="o">=</span> <span class="n">notificationTypeTable</span><span class="p">[</span><span class="n">notificationType</span><span class="p">],</span> 
        <span class="n">relatedObject</span> <span class="o">=</span> <span class="n">relatedObject</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
        <span class="n">notificationId</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">createNotification</span><span class="o">.</span><span class="n">execute</span><span class="p">())</span>
        <span class="n">createPushNotification</span><span class="p">(</span><span class="n">notificationId</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&quot;True&quot;</span>
    <span class="k">return</span> <span class="s">&quot;False&quot;</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/getNotifications&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">getNotifications</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">getNotifications</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="getNotifications"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getNotifications">[docs]</a><span class="k">def</span> <span class="nf">getNotifications</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all of the notifications that have been associated with a user that have not been dismissed</span>

<span class="sd">    :param username: The username to get dismissed notifications for. </span>
<span class="sd">    :type username: str.</span>

<span class="sd">    :returns: json -- The list of notifications each as a json dictionary. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notifications</span> <span class="o">=</span> <span class="n">Notification</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">Notification</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Notification</span><span class="o">.</span><span class="n">dismissed</span> <span class="o">==</span> <span class="bp">False</span><span class="p">))</span>
    <span class="n">notificationList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">notification</span> <span class="ow">in</span> <span class="n">notifications</span><span class="p">:</span>
        <span class="n">notification</span><span class="p">[</span><span class="s">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getNotificationContent</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>
        <span class="n">notification</span><span class="p">[</span><span class="s">&#39;link&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getNotificationLink</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>
        <span class="n">notification</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getNotificationTypeClass</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">notification</span><span class="p">[</span><span class="s">&#39;content&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;DoesNotExist&quot;</span><span class="p">):</span>
            <span class="n">notificationList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">notificationList</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/getAllNotifications&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">getAllNotifications</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">getAllNotifications</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="getAllNotifications"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getAllNotifications">[docs]</a><span class="k">def</span> <span class="nf">getAllNotifications</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all of the notifications that have been associated with a user, whether or not they have been dismissed</span>

<span class="sd">    :param username: The username to get dismissed notifications for. </span>
<span class="sd">    :type username: str.</span>

<span class="sd">    :returns: json -- The list of notifications each as a json dictionary. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notifications</span> <span class="o">=</span> <span class="n">Notification</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Notification</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span>
    <span class="n">notificationList</span> <span class="o">=</span> <span class="p">[]</span> 
    <span class="k">for</span> <span class="n">notification</span> <span class="ow">in</span> <span class="n">notifications</span><span class="p">:</span>
        <span class="n">notification</span><span class="p">[</span><span class="s">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getNotificationContent</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>
        <span class="n">notification</span><span class="p">[</span><span class="s">&#39;link&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getNotificationLink</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>
        <span class="n">notification</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getNotificationTypeClass</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">notification</span><span class="p">[</span><span class="s">&#39;content&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;DoesNotExist&quot;</span><span class="p">):</span>
            <span class="n">notificationList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">notificationList</span><span class="p">)</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/getDismissedNotifications&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">getDismissedNotifications</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">getDismissedNotifications</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="getDismissedNotifications"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getDismissedNotifications">[docs]</a><span class="k">def</span> <span class="nf">getDismissedNotifications</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all of the notifications that have been dismissed for a username</span>

<span class="sd">    :param username: The username to get dismissed notifications for. </span>
<span class="sd">    :type username: str.</span>

<span class="sd">    :returns: json -- The list of notifications each as a json dictionary. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notifications</span> <span class="o">=</span> <span class="n">Notification</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">Notification</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Notification</span><span class="o">.</span><span class="n">dismissed</span> <span class="o">==</span> <span class="bp">True</span><span class="p">))</span>
    <span class="n">notificationList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">notification</span> <span class="ow">in</span> <span class="n">notifications</span><span class="p">:</span>
        <span class="n">notification</span><span class="p">[</span><span class="s">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getNotificationContent</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>
        <span class="n">notification</span><span class="p">[</span><span class="s">&#39;link&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getNotificationLink</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>
        <span class="n">notification</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getNotificationTypeClass</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">notification</span><span class="p">[</span><span class="s">&#39;content&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;DoesNotExist&quot;</span><span class="p">):</span>
            <span class="n">notificationList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">notificationList</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="getNotificationContent"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getNotificationContent">[docs]</a><span class="k">def</span> <span class="nf">getNotificationContent</span><span class="p">(</span><span class="n">notification</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the body/content of the notification depending on its type. </span>

<span class="sd">    :param notification: Dictionary containing [notificationtype] element listing the type being queried. </span>
<span class="sd">    :type notification: dict.</span>

<span class="sd">    :returns: str -- The content of the notification or &#39;DoesNotExist&#39; if the queried object no longer exists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Connection Request&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="n">requestor</span> <span class="o">=</span> <span class="n">Relationship</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Relationship</span><span class="o">.</span><span class="n">connectionid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;relatedObject&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">doesNotExist</span> <span class="o">=</span> <span class="n">Notification</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Notification</span><span class="o">.</span><span class="n">notificationid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationid&#39;</span><span class="p">])</span>
            <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                <span class="n">doesNotExist</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
                <span class="k">return</span> <span class="s">&quot;DoesNotExist&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;You have a new connection request from &quot;</span> <span class="o">+</span> <span class="n">requestor</span><span class="o">.</span><span class="n">requestor</span><span class="o">.</span><span class="n">username</span>
    
    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;New Connection&quot;</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;You have a new connection, click above to view.&quot;</span>
    
    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Prescription Added&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">prescription</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;relatedObject&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">doesNotExist</span> <span class="o">=</span> <span class="n">Notification</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Notification</span><span class="o">.</span><span class="n">notificationid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationid&#39;</span><span class="p">])</span>
            <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                <span class="n">doesNotExist</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
                <span class="k">return</span> <span class="s">&quot;DoesNotExist&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;A new prescription for &quot;</span> <span class="o">+</span> <span class="n">prescription</span><span class="o">.</span><span class="n">medication</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot; has been added to your profile.&quot;</span>

    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Prescription Updated&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">prescription</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;relatedObject&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">doesNotExist</span> <span class="o">=</span> <span class="n">Notification</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Notification</span><span class="o">.</span><span class="n">notificationid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationid&#39;</span><span class="p">])</span>
            <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                <span class="n">doesNotExist</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
                <span class="k">return</span> <span class="s">&quot;DoesNotExist&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;Your prescription for &quot;</span> <span class="o">+</span> <span class="n">prescription</span><span class="o">.</span><span class="n">medication</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot; has been updated.&quot;</span>
    
    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Appointment Invite&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">appointment</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">appid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;relatedObject&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">doesNotExist</span> <span class="o">=</span> <span class="n">Notification</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Notification</span><span class="o">.</span><span class="n">notificationid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationid&#39;</span><span class="p">])</span>
            <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                <span class="n">doesNotExist</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
                <span class="k">return</span> <span class="s">&quot;DoesNotExist&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">appointment</span><span class="o">.</span><span class="n">creator</span><span class="o">.</span><span class="n">username</span> <span class="o">+</span> <span class="s">&quot; has added an appointment with you on &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">appointment</span><span class="o">.</span><span class="n">startdate</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;. Click the link to accept/decline.&quot;</span>

    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Appointment Updated&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">appointment</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">appid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;relatedObject&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">doesNotExist</span> <span class="o">=</span> <span class="n">Notification</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Notification</span><span class="o">.</span><span class="n">notificationid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationid&#39;</span><span class="p">])</span>
            <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                <span class="n">doesNotExist</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
                <span class="k">return</span> <span class="s">&quot;DoesNotExist&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">appointment</span><span class="o">.</span><span class="n">creator</span><span class="o">.</span><span class="n">username</span> <span class="o">+</span> <span class="s">&quot; has updated the following appointment with you: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">appointment</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;. Click the link to accept/decline.&quot;</span>

    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Appointment Cancelled&quot;</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;One of your appointments has been cancelled, click above to view your updated calendar.&quot;</span>

    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Password Reset&quot;</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;Your password has been changed successfully.&quot;</span>

    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Appointment Accepted&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">appointment</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">appid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;relatedObject&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">doesNotExist</span> <span class="o">=</span> <span class="n">Notification</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Notification</span><span class="o">.</span><span class="n">notificationid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationid&#39;</span><span class="p">])</span>
            <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                <span class="n">doesNotExist</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
                <span class="k">return</span> <span class="s">&quot;DoesNotExist&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">appointment</span><span class="o">.</span><span class="n">invitee</span><span class="o">.</span><span class="n">username</span> <span class="o">+</span> <span class="s">&quot; has accepted the appointment with you on &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">appointment</span><span class="o">.</span><span class="n">startdate</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span>

    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Appointment Declined&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">appointment</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">appid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;relatedObject&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">doesNotExist</span> <span class="o">=</span> <span class="n">Notification</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Notification</span><span class="o">.</span><span class="n">notificationid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationid&#39;</span><span class="p">])</span>
            <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                <span class="n">doesNotExist</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
                <span class="k">return</span> <span class="s">&quot;DoesNotExist&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">appointment</span><span class="o">.</span><span class="n">invitee</span><span class="o">.</span><span class="n">username</span> <span class="o">+</span> <span class="s">&quot; has declined the appointment with you on &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">appointment</span><span class="o">.</span><span class="n">startdate</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span>

    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Medication Low&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">prescription</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;relatedObject&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">doesNotExist</span> <span class="o">=</span> <span class="n">Notification</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Notification</span><span class="o">.</span><span class="n">notificationid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationid&#39;</span><span class="p">])</span>
            <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                <span class="n">doesNotExist</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
                <span class="k">return</span> <span class="s">&quot;DoesNotExist&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;You have less than 3 days stock of &quot;</span> <span class="o">+</span> <span class="n">prescription</span><span class="o">.</span><span class="n">medication</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot; left.&quot;</span>

    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Patient Medication Low&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">prescription</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;relatedObject&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">doesNotExist</span> <span class="o">=</span> <span class="n">Notification</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Notification</span><span class="o">.</span><span class="n">notificationid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationid&#39;</span><span class="p">])</span>
            <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                <span class="n">doesNotExist</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
                <span class="k">return</span> <span class="s">&quot;DoesNotExist&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">prescription</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">username</span> <span class="o">+</span> <span class="s">&quot; has less than 3 days stock of &quot;</span> <span class="o">+</span> <span class="n">prescription</span><span class="o">.</span><span class="n">medication</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot; left.&quot;</span>

    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Missed Prescription&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">takeInstance</span> <span class="o">=</span> <span class="n">TakePrescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">TakePrescription</span><span class="o">.</span><span class="n">takeid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;relatedObject&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">prescription</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">takeInstance</span><span class="o">.</span><span class="n">prescriptionid</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">doesNotExist</span> <span class="o">=</span> <span class="n">Notification</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Notification</span><span class="o">.</span><span class="n">notificationid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationid&#39;</span><span class="p">])</span>
            <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                <span class="n">doesNotExist</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
                <span class="k">return</span> <span class="s">&quot;DoesNotExist&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;You only took &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">takeInstance</span><span class="o">.</span><span class="n">currentcount</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; out of &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">prescription</span><span class="o">.</span><span class="n">frequency</span><span class="p">)</span> <span class="o">+</span> \
                    <span class="s">&quot; of &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">prescription</span><span class="o">.</span><span class="n">medication</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">prescription</span><span class="o">.</span><span class="n">dosageform</span> <span class="o">+</span> <span class="s">&quot;(s) &quot;</span> <span class="o">+</span> \
                    <span class="s">&quot; on &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">takeInstance</span><span class="o">.</span><span class="n">currentdate</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Carer Missed Prescription&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">takeInstance</span> <span class="o">=</span> <span class="n">TakePrescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">TakePrescription</span><span class="o">.</span><span class="n">takeid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;relatedObject&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">prescription</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">takeInstance</span><span class="o">.</span><span class="n">prescriptionid</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">doesNotExist</span> <span class="o">=</span> <span class="n">Notification</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Notification</span><span class="o">.</span><span class="n">notificationid</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationid&#39;</span><span class="p">])</span>
            <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                <span class="n">doesNotExist</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
                <span class="k">return</span> <span class="s">&quot;DoesNotExist&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;Your patient &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">prescription</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">username</span><span class="p">)</span> <span class="o">+</span> \
                    <span class="s">&quot; only took &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">takeInstance</span><span class="o">.</span><span class="n">currentcount</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; out of &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">prescription</span><span class="o">.</span><span class="n">frequency</span><span class="p">)</span> <span class="o">+</span> \
                    <span class="s">&quot; of &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">prescription</span><span class="o">.</span><span class="n">medication</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">prescription</span><span class="o">.</span><span class="n">dosageform</span> <span class="o">+</span> <span class="s">&quot;(s) &quot;</span> <span class="o">+</span> \
                    <span class="s">&quot; on &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">takeInstance</span><span class="o">.</span><span class="n">currentdate</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">content</span>
</div>
<div class="viewcode-block" id="getNotificationLink"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getNotificationLink">[docs]</a><span class="k">def</span> <span class="nf">getNotificationLink</span><span class="p">(</span><span class="n">notification</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the link that a specific notification type will link to for web usage. </span>

<span class="sd">    :param notification: Dictionary containing [notificationtype] element listing the type being queried. </span>
<span class="sd">    :type notification: dict.</span>

<span class="sd">    :returns: str -- The web address of the notification subject for JustHealth Web Application. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Connection Request&quot;</span><span class="p">:</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s">&quot;/?go=connections&quot;</span>
    
    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;New Connection&quot;</span><span class="p">:</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s">&quot;/?go=connections&quot;</span>
    
    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Prescription Added&quot;</span><span class="p">:</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s">&quot;/prescriptions&quot;</span>

    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Prescription Updated&quot;</span><span class="p">:</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s">&quot;/prescriptions&quot;</span>
    
    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Appointment Invite&quot;</span><span class="p">:</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s">&quot;/appointmentDetails?id=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">notification</span><span class="p">[</span><span class="s">&#39;relatedObject&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Appointment Updated&quot;</span><span class="p">:</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s">&quot;/appointmentDetails?id=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">notification</span><span class="p">[</span><span class="s">&#39;relatedObject&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Appointment Cancelled&quot;</span><span class="p">:</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s">&quot;/appointments&quot;</span>

    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Appointment Accepted&quot;</span><span class="p">:</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s">&quot;/appointments?open=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">notification</span><span class="p">[</span><span class="s">&#39;relatedObject&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Appointment Declined&quot;</span><span class="p">:</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s">&quot;/appointments?open=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">notification</span><span class="p">[</span><span class="s">&#39;relatedObject&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Password Reset&quot;</span><span class="p">:</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span>

    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Medication Low&quot;</span><span class="p">:</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s">&quot;/prescriptions&quot;</span>

    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Patient Medication Low&quot;</span><span class="p">:</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span>

    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Missed Prescription&quot;</span><span class="p">:</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span>

    <span class="k">if</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Carer Missed Prescription&quot;</span><span class="p">:</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span>
    
    <span class="k">return</span> <span class="n">link</span>
</div>
<div class="viewcode-block" id="getNotificationTypeClass"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getNotificationTypeClass">[docs]</a><span class="k">def</span> <span class="nf">getNotificationTypeClass</span><span class="p">(</span><span class="n">notification</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the &#39;class&#39; of a notification type, used to identify importance / meaning. </span>

<span class="sd">    :param notification: Dictionary containing [notificationtype] element listing the type being queried. </span>
<span class="sd">    :type notification: dict.</span>

<span class="sd">    :returns: str -- One of &#39;danger&#39;, &#39;warning&#39;, &#39;success&#39;, &#39;info&#39;. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notificationClass</span> <span class="o">=</span> <span class="n">Notificationtype</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Notificationtype</span><span class="o">.</span><span class="n">typename</span> <span class="o">==</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;notificationtype&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">notificationClass</span><span class="o">.</span><span class="n">typeclass</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/dismissNotification&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">dismissNotification</span><span class="p">():</span>
    <span class="n">notification</span> <span class="o">=</span> <span class="n">Notification</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Notification</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;notificationid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">notification</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dismissNotification</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;notificationid&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="dismissNotification"><a class="viewcode-back" href="../../api.html#justHealthServer.api.dismissNotification">[docs]</a><span class="k">def</span> <span class="nf">dismissNotification</span><span class="p">(</span><span class="n">notificationid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dismisses a notification to hide from the user&#39;s immediate view. </span>

<span class="sd">    :param notificationid: The id of the notification to dismiss. </span>
<span class="sd">    :type notificationid: int.</span>

<span class="sd">    :returns: str -- &#39;True&#39; if successful, &#39;False&#39; if not. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dismiss</span> <span class="o">=</span> <span class="n">Notification</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dismissed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Notification</span><span class="o">.</span><span class="n">notificationid</span> <span class="o">==</span> <span class="n">notificationid</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
        <span class="n">dismiss</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&quot;True&quot;</span>
    <span class="k">return</span> <span class="s">&quot;False&quot;</span>

<span class="c">##</span>
<span class="c"># Reminder Functionality</span>
<span class="c">##</span>
</div>
<div class="viewcode-block" id="getMinutesDifference"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getMinutesDifference">[docs]</a><span class="k">def</span> <span class="nf">getMinutesDifference</span><span class="p">(</span><span class="n">dateTimeOne</span><span class="p">,</span><span class="n">dateTimeTwo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the difference found by dateTimeOne - dateTimeTwo in minutes.</span>

<span class="sd">    :param dateTimeOne: The first datetime.</span>
<span class="sd">    :type dateTimeOne: datetime. </span>
<span class="sd">    </span>
<span class="sd">    :param dateTimeTwo: The second datetime.</span>
<span class="sd">    :type dateTimeTwo: datetime. </span>

<span class="sd">    :returns: int -- The number of minutes between the two times. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">dateTimeOne</span> <span class="o">-</span> <span class="n">dateTimeTwo</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="getAppointmentsDueIn30"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getAppointmentsDueIn30">[docs]</a><span class="k">def</span> <span class="nf">getAppointmentsDueIn30</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">currentTime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of appointments that are due in 30 minutes or less. </span>
<span class="sd">    </span>
<span class="sd">    :param username: The username to check for. </span>
<span class="sd">    :type username: str. </span>
<span class="sd">    </span>
<span class="sd">    :param currentTime: The current datetime. </span>
<span class="sd">    :type currentTime: datetime.</span>

<span class="sd">    :returns: list -- A list of appointments represented by dicts. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">select</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">Appointments</span><span class="o">.</span><span class="n">creator</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">invitee</span> <span class="o">==</span> <span class="n">username</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">appointment</span> <span class="ow">in</span> <span class="n">select</span><span class="p">:</span>
        <span class="n">appointmentStartTime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">appointment</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">],</span> <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">])</span>
        <span class="n">timeUntil</span> <span class="o">=</span> <span class="n">getMinutesDifference</span><span class="p">(</span><span class="n">appointmentStartTime</span><span class="p">,</span> <span class="n">currentTime</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">timeUntil</span> <span class="o">&lt;=</span> <span class="mi">30</span> <span class="ow">and</span> <span class="n">timeUntil</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">appointment</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="getAppointmentsDueNow"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getAppointmentsDueNow">[docs]</a><span class="k">def</span> <span class="nf">getAppointmentsDueNow</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">currentTime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of appointments that are due now or are in progress. </span>
<span class="sd">    </span>
<span class="sd">    :param username: The username to check for. </span>
<span class="sd">    :type username: str. </span>
<span class="sd">    </span>
<span class="sd">    :param currentTime: The current datetime. </span>
<span class="sd">    :type currentTime: datetime.</span>

<span class="sd">    :returns: list -- A list of appointments represented by dicts. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">select</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">Appointments</span><span class="o">.</span><span class="n">creator</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">invitee</span> <span class="o">==</span> <span class="n">username</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">appointment</span> <span class="ow">in</span> <span class="n">select</span><span class="p">:</span>
        <span class="n">appointmentStartTime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">appointment</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">],</span> <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">])</span>
        <span class="n">timeUntilStart</span> <span class="o">=</span> <span class="n">getMinutesDifference</span><span class="p">(</span><span class="n">appointmentStartTime</span><span class="p">,</span> <span class="n">currentTime</span><span class="p">)</span>
        <span class="n">appointmentEndTime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">appointment</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">],</span> <span class="n">appointment</span><span class="p">[</span><span class="s">&#39;endtime&#39;</span><span class="p">])</span>
        <span class="n">timeUntilEnd</span> <span class="o">=</span> <span class="n">getMinutesDifference</span><span class="p">(</span><span class="n">appointmentEndTime</span><span class="p">,</span> <span class="n">currentTime</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">timeUntilStart</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">timeUntilEnd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">appointment</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="getPrescriptionsDueToday"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getPrescriptionsDueToday">[docs]</a><span class="k">def</span> <span class="nf">getPrescriptionsDueToday</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">currentDateTime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of prescriptions that are due today. </span>
<span class="sd">    </span>
<span class="sd">    :param username: The username to check for. </span>
<span class="sd">    :type username: str. </span>
<span class="sd">    </span>
<span class="sd">    :param currentDateTime: The current datetime. </span>
<span class="sd">    :type currentDateTime: datetime.</span>

<span class="sd">    :returns: list -- A list of prescriptions represented by dicts. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">currentDate</span> <span class="o">=</span> <span class="n">currentDateTime</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="n">currentDay</span> <span class="o">=</span> <span class="n">currentDateTime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%A&quot;</span><span class="p">)</span>

    <span class="n">activePrescriptions</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">startdate</span> <span class="o">&lt;=</span> <span class="n">currentDate</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">enddate</span> <span class="o">&gt;=</span> <span class="n">currentDate</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="s">&quot;Prescription.&quot;</span> <span class="o">+</span> <span class="n">currentDay</span><span class="p">)</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">activePrescriptions</span><span class="p">:</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span>
</div>
<div class="viewcode-block" id="checkMissedPrescriptions"><a class="viewcode-back" href="../../api.html#justHealthServer.api.checkMissedPrescriptions">[docs]</a><span class="k">def</span> <span class="nf">checkMissedPrescriptions</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">currentDate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks to see if a patient has missed any prescriptions</span>
<span class="sd">    and creates notifications if so. </span>

<span class="sd">    :param username: The username to check for.</span>
<span class="sd">    :type username: str. </span>

<span class="sd">    :param currentDate: The current datetime. </span>
<span class="sd">    :type currentDate: datetime. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">listOfPrescriptions</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">listOfPrescriptions</span><span class="p">:</span>
        <span class="n">takeInstance</span> <span class="o">=</span> <span class="n">TakePrescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">TakePrescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">takeInstance</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">currentdate</span> <span class="o">&lt;</span> <span class="n">currentDate</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">currentcount</span> <span class="o">&lt;</span> <span class="n">x</span><span class="o">.</span><span class="n">frequency</span><span class="p">):</span>
                <span class="c"># Does notification already exist?</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">Notification</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">Notification</span><span class="o">.</span><span class="n">notificationtype</span> <span class="o">==</span> <span class="s">&quot;Missed Prescription&quot;</span><span class="p">)</span> <span class="o">&amp;</span>
                        <span class="p">(</span><span class="n">Notification</span><span class="o">.</span><span class="n">relatedObject</span> <span class="o">==</span> <span class="n">i</span><span class="o">.</span><span class="n">takeid</span><span class="p">)</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">Notification</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                    <span class="n">createNotificationRecord</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="s">&quot;Missed Prescription&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">takeid</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">carer</span> <span class="ow">in</span> <span class="n">getCarers</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
                        <span class="n">createNotificationRecord</span><span class="p">(</span><span class="n">carer</span><span class="p">,</span> <span class="s">&quot;Carer Missed Prescription&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">takeid</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="createTakePrescriptionInstances"><a class="viewcode-back" href="../../api.html#justHealthServer.api.createTakePrescriptionInstances">[docs]</a><span class="k">def</span> <span class="nf">createTakePrescriptionInstances</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">currentDateTime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates all TakePrescription instances for any prescription that needs to be taken today. </span>

<span class="sd">    :param username: The username to check for. </span>
<span class="sd">    :type username: str. </span>
<span class="sd">    </span>
<span class="sd">    :param currentDateTime: The current datetime. </span>
<span class="sd">    :type currentDateTime: datetime.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">listOfPrescriptions</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span>
    <span class="n">currentDay</span> <span class="o">=</span> <span class="n">currentDateTime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%A&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">listOfPrescriptions</span><span class="p">:</span>
        <span class="n">dateField</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s">&quot;p.&quot;</span> <span class="o">+</span> <span class="n">currentDay</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dateField</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">TakePrescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">TakePrescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">prescriptionid</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">TakePrescription</span><span class="o">.</span><span class="n">currentdate</span> <span class="o">==</span> <span class="n">currentDateTime</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
                <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">TakePrescription</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;You are due to take &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">dosageform</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;(s) of &quot;</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">medication</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">frequency</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; time(s) today.&quot;</span>
                <span class="n">sendPushNotification</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="s">&quot;Prescription Due Today&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                    <span class="n">insert</span> <span class="o">=</span> <span class="n">TakePrescription</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                                <span class="n">prescriptionid</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">prescriptionid</span><span class="p">,</span>
                                <span class="n">currentcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="n">startingcount</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stockleft</span><span class="p">,</span>
                                <span class="n">currentdate</span> <span class="o">=</span> <span class="n">currentDateTime</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
                    <span class="n">takePrescriptionId</span> <span class="o">=</span> <span class="n">insert</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="pingServer"><a class="viewcode-back" href="../../api.html#justHealthServer.api.pingServer">[docs]</a><span class="k">def</span> <span class="nf">pingServer</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks to see if there are any reminders to create/delete, runs on every request.</span>

<span class="sd">    Also called by a scheduled task for all users. See :func:`generation`. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">loggedInUser</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="n">deleteReminders</span><span class="p">(</span><span class="n">loggedInUser</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">getAppointmentsDueIn30</span><span class="p">(</span><span class="n">loggedInUser</span><span class="p">,</span> <span class="n">dt</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">getAppointmentsDueNow</span><span class="p">(</span><span class="n">loggedInUser</span><span class="p">,</span> <span class="n">dt</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">getPrescriptionsDueToday</span><span class="p">(</span><span class="n">loggedInUser</span><span class="p">,</span> <span class="n">dt</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">addReminders</span><span class="p">(</span><span class="n">loggedInUser</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

        <span class="n">createTakePrescriptionInstances</span><span class="p">(</span><span class="n">loggedInUser</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
        <span class="n">checkMissedPrescriptions</span><span class="p">(</span><span class="n">loggedInUser</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>

    <span class="c"># No-one logged in</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="addReminders"><a class="viewcode-back" href="../../api.html#justHealthServer.api.addReminders">[docs]</a><span class="k">def</span> <span class="nf">addReminders</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">now</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add all new reminders to the Reminder table.</span>

<span class="sd">    :param username: The username to add reminders for.</span>
<span class="sd">    :type username: str.</span>

<span class="sd">    :param now: The current datetime.</span>
<span class="sd">    :type now: datetime. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Get All Reminders (Saving on performance hits later)</span>
    <span class="n">allReminders</span> <span class="o">=</span> <span class="n">Reminder</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Reminder</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span>

    <span class="n">appointmentsDueIn30</span> <span class="o">=</span> <span class="n">getAppointmentsDueIn30</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">appointmentsDueIn30</span><span class="p">:</span>
        <span class="n">withUser</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s">&#39;creator&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">withUser</span> <span class="o">==</span> <span class="n">username</span><span class="p">:</span>
            <span class="n">withUser</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s">&#39;invitee&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">allReminders</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">Reminder</span><span class="o">.</span><span class="n">relatedObjectTable</span> <span class="o">==</span> <span class="s">&#39;Appointments&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Reminder</span><span class="o">.</span><span class="n">relatedObject</span> <span class="o">==</span> <span class="n">a</span><span class="p">[</span><span class="s">&#39;appid&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">reminderClass</span> <span class="o">==</span> <span class="s">&quot;danger&quot;</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">Reminder</span><span class="o">.</span><span class="n">DoesNotExist</span>
        <span class="k">except</span> <span class="n">Reminder</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>

            <span class="c"># Is the appointment with another user?</span>
            <span class="k">if</span> <span class="n">withUser</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">insertContent</span> <span class="o">=</span> <span class="s">&quot;Your &quot;</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="s">&#39;apptype&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot; appointment starts at &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">insertContent</span> <span class="o">=</span> <span class="s">&quot;Your &quot;</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="s">&#39;apptype&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot; appointment with &quot;</span> <span class="o">+</span> <span class="n">withUser</span> <span class="o">+</span> <span class="s">&quot; starts at &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">])</span>
            
            <span class="c"># Create the reminder</span>
            <span class="n">insertReminder</span> <span class="o">=</span> <span class="n">Reminder</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">username</span> <span class="o">=</span> <span class="n">username</span><span class="p">,</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">insertContent</span><span class="p">,</span>
                <span class="n">reminderClass</span> <span class="o">=</span> <span class="s">&quot;warning&quot;</span><span class="p">,</span>
                <span class="n">relatedObjectTable</span> <span class="o">=</span> <span class="s">&quot;Appointments&quot;</span><span class="p">,</span>
                <span class="n">relatedObject</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s">&#39;appid&#39;</span><span class="p">],</span>
                <span class="n">extraDate</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s">&#39;startdate&#39;</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">]))</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                <span class="n">insertReminder</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="n">appointmentsDueNow</span> <span class="o">=</span> <span class="n">getAppointmentsDueNow</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">appointmentsDueNow</span><span class="p">:</span>
        <span class="n">withUser</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s">&#39;creator&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">withUser</span> <span class="o">==</span> <span class="n">username</span><span class="p">:</span>
            <span class="n">withUser</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s">&#39;invitee&#39;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">allReminders</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">Reminder</span><span class="o">.</span><span class="n">relatedObjectTable</span> <span class="o">==</span> <span class="s">&#39;Appointments&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Reminder</span><span class="o">.</span><span class="n">relatedObject</span> <span class="o">==</span> <span class="n">a</span><span class="p">[</span><span class="s">&#39;appid&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">reminderClass</span> <span class="o">==</span> <span class="s">&quot;warning&quot;</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">Reminder</span><span class="o">.</span><span class="n">DoesNotExist</span>
        <span class="k">except</span> <span class="n">Reminder</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            
            <span class="c"># Is the appointment with another user?</span>
            <span class="k">if</span> <span class="n">withUser</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">insertContent</span> <span class="o">=</span> <span class="s">&quot;Your &quot;</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="s">&#39;apptype&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot; appointment starts at &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">insertContent</span> <span class="o">=</span> <span class="s">&quot;Your &quot;</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="s">&#39;apptype&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot; appointment with &quot;</span> <span class="o">+</span> <span class="n">withUser</span> <span class="o">+</span> <span class="s">&quot; starts at &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">])</span>

            <span class="c"># Create the reminder</span>
            <span class="n">insertReminder</span> <span class="o">=</span> <span class="n">Reminder</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">username</span> <span class="o">=</span> <span class="n">username</span><span class="p">,</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">insertContent</span><span class="p">,</span>
                <span class="n">reminderClass</span> <span class="o">=</span> <span class="s">&quot;danger&quot;</span><span class="p">,</span>
                <span class="n">relatedObjectTable</span> <span class="o">=</span> <span class="s">&quot;Appointments&quot;</span><span class="p">,</span>
                <span class="n">relatedObject</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s">&#39;appid&#39;</span><span class="p">],</span>
                <span class="n">extraDate</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s">&#39;enddate&#39;</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="s">&#39;endtime&#39;</span><span class="p">]))</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                <span class="n">insertReminder</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="n">prescriptionsDueToday</span> <span class="o">=</span> <span class="n">getPrescriptionsDueToday</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prescriptionsDueToday</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">allReminders</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">Reminder</span><span class="o">.</span><span class="n">relatedObjectTable</span> <span class="o">==</span> <span class="s">&quot;Prescription&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Reminder</span><span class="o">.</span><span class="n">relatedObject</span> <span class="o">==</span> <span class="n">p</span><span class="p">[</span><span class="s">&#39;prescriptionid&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">Reminder</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;You are due to take &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;quantity&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;dosageform&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot;(s) of &quot;</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="s">&#39;medication&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;frequency&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot; time(s) today.&quot;</span>

            <span class="n">insertReminder</span> <span class="o">=</span> <span class="n">Reminder</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">username</span> <span class="o">=</span> <span class="n">username</span><span class="p">,</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="p">,</span>
                <span class="n">reminderClass</span> <span class="o">=</span> <span class="s">&quot;info&quot;</span><span class="p">,</span>
                <span class="n">relatedObjectTable</span> <span class="o">=</span> <span class="s">&quot;Prescription&quot;</span><span class="p">,</span>
                <span class="n">relatedObject</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s">&#39;prescriptionid&#39;</span><span class="p">],</span>
                <span class="n">extraFrequency</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;frequency&#39;</span><span class="p">]))</span>

            <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                <span class="n">insertReminder</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="deleteReminders"><a class="viewcode-back" href="../../api.html#justHealthServer.api.deleteReminders">[docs]</a><span class="k">def</span> <span class="nf">deleteReminders</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">now</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes any reminders for appointments or prescriptions</span>
<span class="sd">    that have expired or are no longer current. </span>

<span class="sd">    :param username: The username to check.</span>
<span class="sd">    :type username: str.</span>

<span class="sd">    :param now: The current datetime</span>
<span class="sd">    :type now: datetime.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Get all Reminders</span>
    <span class="n">allReminders</span> <span class="o">=</span> <span class="n">Reminder</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Reminder</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span>

    <span class="c"># Appointments</span>
    <span class="c"># Need to remove all reminders that are no longer immediately happening / 15mins. </span>
    <span class="n">appointmentReminders</span> <span class="o">=</span> <span class="n">allReminders</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Reminder</span><span class="o">.</span><span class="n">relatedObjectTable</span> <span class="o">==</span> <span class="s">&quot;Appointments&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">appointmentReminders</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">allAppointments</span> <span class="o">=</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">Appointments</span><span class="o">.</span><span class="n">creator</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">invitee</span> <span class="o">==</span> <span class="n">username</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">reminder</span> <span class="ow">in</span> <span class="n">appointmentReminders</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">appointment</span> <span class="o">=</span> <span class="n">allAppointments</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">enddate</span><span class="p">,</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">endtime</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Appointments</span><span class="o">.</span><span class="n">appid</span> <span class="o">==</span> <span class="n">reminder</span><span class="o">.</span><span class="n">relatedObject</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="n">appointmentEndDateTime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">appointment</span><span class="o">.</span><span class="n">enddate</span><span class="p">,</span> <span class="n">appointment</span><span class="o">.</span><span class="n">endtime</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">appointmentEndDateTime</span> <span class="o">&lt;</span> <span class="n">now</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                        <span class="n">reminder</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">Appointments</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                    <span class="n">reminder</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>

    <span class="c"># Prescriptions</span>
    <span class="c"># Need to remove all prescriptions that are not on the current day or start date &gt; now or end date &lt; now. </span>
    <span class="n">prescriptionReminders</span> <span class="o">=</span> <span class="n">allReminders</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Reminder</span><span class="o">.</span><span class="n">relatedObjectTable</span> <span class="o">==</span> <span class="s">&quot;Prescription&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">appointmentReminders</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">allPrescriptions</span> <span class="o">=</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span>
        <span class="n">currentDay</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%A&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">reminder</span> <span class="ow">in</span> <span class="n">prescriptionReminders</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">prescription</span> <span class="o">=</span> <span class="n">allPrescriptions</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">prescriptionid</span> <span class="o">==</span> <span class="n">reminder</span><span class="o">.</span><span class="n">relatedObject</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">((</span><span class="nb">eval</span><span class="p">(</span><span class="s">&quot;prescription.&quot;</span> <span class="o">+</span> <span class="n">currentDay</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">startdate</span> <span class="o">&gt;</span> <span class="n">now</span><span class="o">.</span><span class="n">date</span><span class="p">())</span> <span class="ow">or</span> <span class="p">(</span><span class="n">Prescription</span><span class="o">.</span><span class="n">enddate</span> <span class="o">&lt;</span> <span class="n">now</span><span class="o">.</span><span class="n">date</span><span class="p">())):</span>
                    <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                        <span class="n">reminder</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">Prescription</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                    <span class="n">reminder</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="getReminders"><a class="viewcode-back" href="../../api.html#justHealthServer.api.getReminders">[docs]</a><span class="k">def</span> <span class="nf">getReminders</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all reminders for a specific user.</span>

<span class="sd">    :param username: The username to get reminders for.</span>
<span class="sd">    :type username: str. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">allReminders</span> <span class="o">=</span> <span class="n">Reminder</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Reminder</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span>
    <span class="n">reminders</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">allReminders</span><span class="p">:</span>
        <span class="n">reminders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">reminders</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="passwordExpiration"><a class="viewcode-back" href="../../api.html#justHealthServer.api.passwordExpiration">[docs]</a><span class="k">def</span> <span class="nf">passwordExpiration</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This checks whether the password that the user is using is about to expire.</span>

<span class="sd">    :param username: The username to check password for. </span>
<span class="sd">    :type username: str. </span>

<span class="sd">    :returns: result -- Whether the password is valid, expiring soon or needs to be reset. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">passwordDetails</span> <span class="o">=</span> <span class="n">uq8LnAWi7D</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">uq8LnAWi7D</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">uq8LnAWi7D</span><span class="o">.</span><span class="n">iscurrent</span><span class="o">==</span><span class="bp">True</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">expirationDate</span> <span class="o">=</span> <span class="n">passwordDetails</span><span class="o">.</span><span class="n">expirydate</span>
    <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="n">remainingDays</span> <span class="o">=</span> <span class="p">((</span><span class="n">expirationDate</span> <span class="o">-</span> <span class="n">today</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span><span class="o">/</span><span class="mi">86400</span>
    <span class="c">#check the number of days until expiration</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">remainingDays</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;Reset&quot;</span>
    <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">remainingDays</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">:</span> 
        <span class="k">return</span> <span class="s">&quot;&lt;11&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;Authenticated&quot;</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/expiredResetPassword&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">expiredResetPassword</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">verifyContentRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">expiredResetPassword</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>

<div class="viewcode-block" id="expiredResetPassword"><a class="viewcode-back" href="../../api.html#justHealthServer.api.expiredResetPassword">[docs]</a><span class="k">def</span> <span class="nf">expiredResetPassword</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resets a password that has expired or is expiring. </span>
<span class="sd">    </span>
<span class="sd">    :param request: Dictionary of user and password details [username, newpassword, confirmnewpassword]. </span>
<span class="sd">    :type request: dict. </span>
<span class="sd">    </span>
<span class="sd">    :returns: str -- True if successful, False if not. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">[</span><span class="s">&#39;confirmnewpassword&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">request</span><span class="p">[</span><span class="s">&#39;newpassword&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s">&quot;Unmatched&quot;</span>
        
    <span class="n">newPassword</span> <span class="o">=</span> <span class="n">sha256_crypt</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="s">&#39;newpassword&#39;</span><span class="p">])</span>

    <span class="c"># Set existing passwords to not current</span>
    <span class="n">notCurrent</span> <span class="o">=</span> <span class="n">uq8LnAWi7D</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">iscurrent</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">uq8LnAWi7D</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">user</span><span class="p">)</span>
    
    <span class="c">#check its not the same as old passwords - this does not work as passwords hash as something different each time due to the different salt used.</span>
    <span class="c"># oldPasswords = uq8LnAWi7D.select(uq8LnAWi7D.password).dicts().where(uq8LnAWi7D.username == user).order_by(uq8LnAWi7D.expirydate.desc()).limit(5)</span>
    <span class="c"># oldPasswords.execute()</span>
    <span class="c"># for this in oldPasswords:</span>
    <span class="c">#     if newPassword == this:</span>
    <span class="c">#         return &quot;Exists&quot;</span>

    <span class="c"># Build insert password query</span>
    <span class="n">newCredentials</span> <span class="o">=</span> <span class="n">uq8LnAWi7D</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
      <span class="n">username</span> <span class="o">=</span> <span class="n">user</span><span class="p">,</span>  
      <span class="n">password</span> <span class="o">=</span> <span class="n">newPassword</span><span class="p">,</span>
      <span class="n">iscurrent</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
      <span class="n">expirydate</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">90</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
        <span class="n">notCurrent</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="n">newCredentials</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

        <span class="n">createNotificationRecord</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s">&quot;Password Reset&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&quot;True&quot;</span>
    <span class="k">return</span> <span class="s">&quot;False&quot;</span>


<span class="c"># def checkPrescriptionLevel(username, activePrescriptions):</span>
<span class="c">#     today = datetime.datetime.now().date()</span>
<span class="c">#     for prescription in activePrescriptions:</span>
<span class="c">#         if(prescription[&#39;stockleft&#39;] &lt; 10):</span>
<span class="c">#             if Notification.select().where((Notification.username == username) &amp; (Notification.dismissed == False) &amp; (Notification.notificationtype == &quot;Medication Low&quot;) &amp; (Notification.relatedObject == prescription[&#39;prescriptionid&#39;])).count() == 0:</span>
<span class="c">#                 createNotificationRecord(username, &quot;Medication Low&quot;, prescription[&#39;prescriptionid&#39;])</span>
</div>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/generate&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="generation"><a class="viewcode-back" href="../../api.html#justHealthServer.api.generation">[docs]</a><span class="k">def</span> <span class="nf">generation</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cleans up all Notifications / Reminders for all users, run via a scheduled task on the server. </span>
<span class="sd">    </span>
<span class="sd">    :returns: str -- The number of reminders created/deleted. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">startReminderCount</span> <span class="o">=</span> <span class="n">Reminder</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">Client</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
        <span class="n">deleteReminders</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
        <span class="n">addReminders</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
        <span class="n">createTakePrescriptionInstances</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
        <span class="n">checkMissedPrescriptions</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
    <span class="n">endReminderCount</span> <span class="o">=</span> <span class="n">Reminder</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="k">return</span> <span class="s">&quot;Generated &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">((</span><span class="n">startReminderCount</span> <span class="o">-</span> <span class="n">endReminderCount</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot; reminders&quot;</span>

<span class="c">##</span>
<span class="c"># Signalling</span>
<span class="c">##</span>

<span class="c"># Causes the reminder ping to execute every time the server recieves a request.</span></div>
<span class="n">request_started</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">pingServer</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Charlotte Hutchinson, Rich Logan, Ben McGregor, Stephen Tate.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>